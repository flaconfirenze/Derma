<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.95">
    <title>Appcloner Maker - Enhanced Floating Editor</title>
    <style>
        :root {
          --primary-blue: #1a73e8;
          --hover-blue: #1557b0;
          --bg-gray: #f8f9fa;
          --border-gray: #dadce0;
          --success-green: #34a853;
          --warning-orange: #fbbc04;
          --error-red: #ea4335;
        }
        body {
          font-family: 'Roboto', sans-serif;
          margin: 0;
          padding: 16px;
          background: white;
        }
        .container {
          max-width: 800px;
          margin: 0 auto;
        }
        .category {
          margin-bottom: 24px;
          border: 1px solid var(--border-gray);
          border-radius: 8px;
        }
        .category-header {
          background: var(--primary-blue);
          color: white;
          padding: 12px 16px;
          border-radius: 8px 8px 0 0;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .category-content {
          padding: 8px;
          display: none;
        }
        .category-content.active {
          display: block;
        }
        .chevron { 
          transition: transform 0.3s; 
          font-size: 16px;
        }
        .chevron.active { transform: rotate(180deg); }

        /* Enhanced Setting Row */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .setting-row:last-child {
            border-bottom: none;
        }
        .setting-row:hover {
            background-color: var(--bg-gray);
            transform: translateX(4px);
        }
        .setting-row.has-children::before {
            content: 'üóÇÔ∏è';
            position: absolute;
            left: -8px;
            font-size: 12px;
            opacity: 0.6;
        }
        .setting-row-label {
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .setting-row-type-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--border-gray);
            color: #666;
            font-weight: normal;
        }
        .setting-row-value {
            font-size: 14px;
            color: #555;
            background-color: #eef2ff;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            color: var(--primary-blue);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .setting-row-value.enabled { background-color: #e8f5e8; color: var(--success-green); }
        .setting-row-value.disabled { background-color: #ffebee; color: var(--error-red); }
        .setting-row-value.custom { background-color: #fff3e0; color: var(--warning-orange); }

        .save-btn {
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: var(--primary-blue);
          color: white;
          padding: 12px 24px;
          border-radius: 24px;
          border: none;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          z-index: 1000;
          transition: all 0.2s;
        }
        .save-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Enhanced Floating Editor */
        .floating-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            backdrop-filter: blur(4px);
        }
        .floating-editor-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .floating-editor-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        .floating-editor-overlay.visible .floating-editor-content {
            transform: scale(1) translateY(0);
        }
        .floating-editor-header {
            padding: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: #111;
            border-bottom: 2px solid var(--border-gray);
            background: linear-gradient(135deg, var(--bg-gray) 0%, #ffffff 100%);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .editor-close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: var(--error-red);
        }
        .floating-editor-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .floating-editor-footer {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            border-top: 2px solid var(--border-gray);
            background-color: var(--bg-gray);
            border-radius: 0 0 12px 12px;
        }
        .editor-footer-info {
            font-size: 12px;
            color: #666;
        }
        .editor-footer-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .editor-button {
            padding: 0.6rem 1.2rem;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background-color: transparent;
            color: var(--primary-blue);
        }
        .editor-button.primary {
            background-color: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        .editor-button:hover { 
            background-color: rgba(26, 115, 232, 0.1);
            border-color: var(--primary-blue);
        }
        .editor-button.primary:hover { 
            background-color: var(--hover-blue);
            transform: translateY(-1px);
        }

        /* Enhanced Editor Controls */
        .editor-setting { 
            margin-bottom: 24px; 
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            overflow: hidden;
        }
        .editor-setting-label { 
            display: block; 
            margin-bottom: 8px; 
            color: #333; 
            font-weight: 600;
            font-size: 15px;
        }
        .editor-parent-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border: 2px solid var(--primary-blue);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .editor-parent-header {
            background: var(--primary-blue);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .editor-parent-toggle {
            width: 20px;
            height: 20px;
        }
        .editor-child-settings {
            padding: 16px;
            border-left: 4px solid var(--primary-blue);
            margin-left: 12px;
            background: rgba(26, 115, 232, 0.02);
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }
        .editor-child-settings.disabled {
            opacity: 0.5;
            background: rgba(0,0,0,0.02);
            border-left-color: #ccc;
        }
        .editor-simple-setting {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 16px;
        }
        .editor-checkbox-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 8px;
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        .editor-checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: var(--primary-blue);
        }
        .editor-checkbox-row label {
            font-weight: 500;
            color: #333;
        }
        .editor-setting input[type="text"], 
        .editor-setting input[type="number"], 
        .editor-setting select, 
        .editor-setting textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.2s;
            font-family: inherit;
        }
        .editor-setting input:focus,
        .editor-setting select:focus,
        .editor-setting textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            outline: none;
        }
        .custom-input-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-top: 8px; 
        }
        .generate-btn { 
            padding: 10px 16px; 
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--hover-blue) 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            flex-shrink: 0;
            font-weight: 500;
            transition: all 0.2s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        .editor-setting textarea { 
            min-height: 120px; 
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .setting-type-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .type-parent { background: var(--primary-blue); }
        .type-boolean { background: var(--success-green); }
        .type-array { background: var(--warning-orange); }
        .type-string { background: #9c27b0; }
        .type-number { background: #ff5722; }
        
        #loading, #error-message { text-align: center; padding: 20px; }
        #error-message { 
            color: var(--error-red); 
            background: #ffebee; 
            border-radius: 8px;
            border-left: 4px solid var(--error-red);
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .setting-row {
            animation: fadeInUp 0.3s ease-out;
        }
    </style>
</head>
<body>

<div class="container">
  <div id="package-info" style="padding: 16px; background: linear-gradient(135deg, #eef2ff 0%, #f8f9ff 100%); border-radius: 12px; margin-bottom: 16px; display: none; border: 1px solid rgba(26, 115, 232, 0.2);">
    <p style="margin: 0 0 8px 0;"><strong>üì¶ Package:</strong> <span id="packageNameDisplay" style="color: var(--primary-blue);">Not detected</span></p>
    <p style="margin: 0;"><strong>üî¢ Split Count:</strong> <span id="splitCountDisplay" style="color: var(--primary-blue);">101</span></p>
  </div>
  <div id="loading">‚è≥ Loading configuration...</div>
  <div id="error-message" class="error-message" style="display: none;"></div>
  <div id="config-container"></div>
  <button class="save-btn" onclick="saveConfig()">üíæ Save Settings</button>
</div>

<!-- Enhanced Floating Editor -->
<div id="floating-editor-overlay" class="floating-editor-overlay">
    <div id="floating-editor-content" class="floating-editor-content">
        <div id="floating-editor-header" class="floating-editor-header">
            <span id="floating-editor-title">Edit Setting</span>
            <button class="editor-close-btn" onclick="closeFloatingEditor()">&times;</button>
        </div>
        <div id="floating-editor-body" class="floating-editor-body"></div>
        <div class="floating-editor-footer">
            <div class="editor-footer-info" id="editor-info"></div>
            <div class="editor-footer-buttons">
                <button id="editor-cancel-btn" class="editor-button">Cancel</button>
                <button id="editor-save-btn" class="editor-button primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- Enhanced Constants and State ---
const BIN_ID = '67fe9e1f8960c979a585d694';
const API_KEY = '$2a$10$SgT4qoOKXP6CD4u1jPEpduwi.2NbrCqV2u71AaL7mGaW.77CmNU7u';
let jsonConfig = {};
let originalJsonConfig = {};
let currentPackageName = "";
let configFileSplitCount = 101;
let allChildKeys = new Set();
let allParentKeys = new Set();
let parentChildMap = new Map(); // Maps parent keys to their children

const keysWithCustomOption = [
    'changeAndroidId', 'changeImei', 'changeAndroidSerial', 'changeWifiMacAddress',
    'changeBluetoothMacAddress', 'changeImsi', 'changeGoogleAdvertisingId', 'changeGoogleServiceFrameworkId',
    'changeFacebookAttributionId', 'changeAppSetId', 'changeOpenId', 'changeAmazonAdvertisingId', 
    'changeHuaweiAdvertisingId', 'changeLocale', 'changeEthernetMacAddress'
];

const NON_INTERACTIVE_DIRECTORY_KEYS = ['addPermissions', 'addProviders', 'addReceivers','addServices','addActivities','stringsProperties','serialFormat'];

// --- Enhanced Initialization ---
document.addEventListener('DOMContentLoaded', loadConfiguration);

async function loadConfiguration() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-message');
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { 'X-Master-Key': API_KEY }
        });
        if (!response.ok) throw new Error(`Failed to load configuration (Status: ${response.status})`);
        const data = await response.json();
        jsonConfig = data.record;
        originalJsonConfig = JSON.parse(JSON.stringify(jsonConfig));
        
        analyzeParentChildRelationships();
        renderConfiguration(jsonConfig);
    } catch (error) {
        errorEl.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
        errorEl.style.display = 'block';
        console.error("Configuration Load Error:", error);
    } finally {
        loadingEl.style.display = 'none';
    }
}

// --- Enhanced Parent-Child Analysis ---
function analyzeParentChildRelationships() {
    allChildKeys.clear();
    allParentKeys.clear();
    parentChildMap.clear();
    
    // Automatic detection rules
    for (const category in jsonConfig) {
        const settings = jsonConfig[category];
        
        for (const key in settings) {
            // Rule 1: Object parents (have properties including 'enabled')
            if (typeof settings[key] === 'object' && settings[key] !== null && !Array.isArray(settings[key])) {
                allParentKeys.add(key);
                const children = Object.keys(settings[key]).filter(childKey => childKey !== 'enabled');
                parentChildMap.set(key, children);
                children.forEach(child => allChildKeys.add(child));
            }
            
            // Rule 2: Boolean parents (boolean keys that are prefixes of other keys)
            if (typeof settings[key] === 'boolean') {
                const relatedKeys = [];
                for (const otherKey in settings) {
                    if (key !== otherKey && otherKey.startsWith(key) && 
                        otherKey.length > key.length &&
                        otherKey.charAt(key.length) === otherKey.charAt(key.length).toUpperCase()) {
                        relatedKeys.push(otherKey);
                    }
                }
                if (relatedKeys.length > 0) {
                    allParentKeys.add(key);
                    parentChildMap.set(key, relatedKeys);
                    relatedKeys.forEach(child => allChildKeys.add(child));
                }
            }
        }
    }

    // --- START: Manual registration for groups with inconsistent naming ---

    // Manual registration for 'buildsProps'
    const buildPropsParent = 'buildsProps';
    for (const category in jsonConfig) {
        const settings = jsonConfig[category];
        if (settings.hasOwnProperty(buildPropsParent)) {
            const children = Object.keys(settings).filter(k => k.startsWith('buildProps'));
            if (children.length > 0) {
                allParentKeys.add(buildPropsParent);
                parentChildMap.set(buildPropsParent, children);
                children.forEach(child => allChildKeys.add(child));
            }
            break;
        }
    }

    // Manual registration for 'dnsOverHttps'
    const dohParent = 'dnsOverHttps';
    for (const category in jsonConfig) {
        const settings = jsonConfig[category];
        if (settings.hasOwnProperty(dohParent)) {
            // Find all keys that are likely children but aren't detected automatically
            const children = Object.keys(settings).filter(k =>
                k !== dohParent && (k.toLowerCase().includes('dns') || k.toLowerCase().includes('doh'))
            );

            if (children.length > 0) {
                const existingChildren = parentChildMap.get(dohParent) || [];
                const allChildren = [...new Set([...existingChildren, ...children])];

                allParentKeys.add(dohParent);
                parentChildMap.set(dohParent, allChildren);
                allChildren.forEach(child => allChildKeys.add(child));
            }
            break;
        }
    }
    // --- END: Manual registration ---
    
    console.log('üîç Analysis Complete:', {
        parents: Array.from(allParentKeys),
        children: Array.from(allChildKeys),
        relationships: Object.fromEntries(parentChildMap)
    });
}

// --- Android Bridge ---
function updatePackageName(packageName) {
    currentPackageName = packageName;
    document.getElementById('packageNameDisplay').textContent = packageName;
    document.getElementById('package-info').style.display = 'block';
}
function updateSplitCount(count) {
    configFileSplitCount = count;
    document.getElementById('splitCountDisplay').textContent = count;
    document.getElementById('package-info').style.display = 'block';
}

// --- Enhanced UI Rendering ---
function renderConfiguration(config) {
    const container = document.getElementById('config-container');
    container.innerHTML = '';

    Object.entries(config).forEach(([category, settings]) => {
        const categoryElement = document.createElement('div');
        categoryElement.className = 'category';
        
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<span>üìÅ ${formatLabel(category)}</span><span class="chevron">‚åµ</span>`;
        header.onclick = () => {
            content.classList.toggle('active');
            header.querySelector('.chevron').classList.toggle('active');
        };
        
        const content = document.createElement('div');
        content.className = 'category-content';
        
        // Only render main settings (parents and standalone settings)
        for (const key in settings) {
            if (Object.hasOwnProperty.call(settings, key) && 
                !allChildKeys.has(key) && 
                !NON_INTERACTIVE_DIRECTORY_KEYS.includes(key)) {
                content.appendChild(createEnhancedSettingRow(key, settings[key], category));
            }
        }

        if (content.hasChildNodes()) {
            categoryElement.appendChild(header);
            categoryElement.appendChild(content);
            container.appendChild(categoryElement);
        }
    });
}

function createEnhancedSettingRow(key, value, category) {
    const row = document.createElement('div');
    row.className = 'setting-row';
    
    const isParent = allParentKeys.has(key);
    if (isParent) {
        row.classList.add('has-children');
    }
    
    row.dataset.key = key;
    row.dataset.category = category;
    row.onclick = () => openFloatingEditor(key, category);

    const label = document.createElement('div');
    label.className = 'setting-row-label';
    
    const typeIndicator = getSettingTypeIndicator(key, value);
    const typeBadge = getSettingTypeBadge(key, value);
    
    label.innerHTML = `
        ${typeIndicator}
        <span>${formatLabel(key)}</span>
        ${typeBadge}
    `;

    const valueDisplay = document.createElement('div');
    valueDisplay.className = 'setting-row-value';
    const {text, className} = getEnhancedSummaryText(key, value, category);
    valueDisplay.textContent = text;
    
    if (className) {
        valueDisplay.classList.add(className);
    }
    
    row.appendChild(label);
    row.appendChild(valueDisplay);
    return row;
}

function getSettingTypeIndicator(key, value) {
    if (allParentKeys.has(key)) return '<span class="setting-type-indicator type-parent"></span>';
    if (typeof value === 'boolean') return '<span class="setting-type-indicator type-boolean"></span>';
    if (Array.isArray(value)) return '<span class="setting-type-indicator type-array"></span>';
    if (typeof value === 'number') return '<span class="setting-type-indicator type-number"></span>';
    return '<span class="setting-type-indicator type-string"></span>';
}

function getSettingTypeBadge(key, value) {
    if (allParentKeys.has(key)) {
        const childCount = parentChildMap.get(key)?.length || 0;
        return `<span class="setting-row-type-badge">üë• ${childCount} options</span>`;
    }
    if (typeof value === 'boolean') return '<span class="setting-row-type-badge">‚è∞ Toggle</span>';
    if (Array.isArray(value)) return '<span class="setting-row-type-badge">üìã List</span>';
    if (typeof value === 'number') return '<span class="setting-row-type-badge">üî¢ Number</span>';
    return '<span class="setting-row-type-badge">üìù Text</span>';
}

function getEnhancedSummaryText(key, value, category) {
    const isObjectParent = typeof value === 'object' && value !== null && !Array.isArray(value);
    const isBooleanParent = allParentKeys.has(key) && typeof value === 'boolean';
    
    if (isObjectParent) {
        return {
            text: value.enabled ? "‚úÖ Enabled" : "‚ùå Disabled",
            className: value.enabled ? "enabled" : "disabled"
        };
    }
    if (isBooleanParent) {
        return {
            text: value ? "‚úÖ Enabled" : "‚ùå Disabled", 
            className: value ? "enabled" : "disabled"
        };
    }
    
    if (typeof value === 'boolean') {
        return {
            text: value ? "üü¢ On" : "‚ö´ Off",
            className: value ? "enabled" : "disabled"
        };
    }

    if (Array.isArray(value)) {
        if (value.length === 0) return {text: "[0 items]", className: "disabled"};
        const originalOptions = originalJsonConfig[category]?.[key];
        if (keysWithCustomOption.includes(key) && Array.isArray(originalOptions) && 
            originalOptions.indexOf(value[0]) === -1) {
            return {text: "üé® Custom", className: "custom"};
        }
        if (typeof value[0] === 'string') {
            return {text: value[0], className: ""};
        }
        return {text: `[${value.length} items]`, className: ""};
    }
    
    if (typeof value === 'string' && value.length > 15) {
        return {text: value.substring(0, 12) + '...', className: ""};
    }
    
    return {text: value || 'Not set', className: value ? "" : "disabled"};
}

// --- Enhanced Floating Editor ---
const editorOverlay = document.getElementById('floating-editor-overlay');
const editorTitle = document.getElementById('floating-editor-title');
const editorBody = document.getElementById('floating-editor-body');
const editorInfo = document.getElementById('editor-info');

function openFloatingEditor(key, category) {
    const isParent = allParentKeys.has(key);
    const children = parentChildMap.get(key) || [];
    
    editorTitle.innerHTML = `
        ${getSettingTypeIndicator(key, jsonConfig[category][key])}
        <strong>${formatLabel(key)}</strong>
    `;
    
    editorInfo.textContent = isParent ? 
        `Parent setting with ${children.length} child options` : 
        'Simple setting';
    
    editorBody.innerHTML = '';
    editorBody.appendChild(createEnhancedEditorControls(key, category));
    editorOverlay.dataset.key = key;
    editorOverlay.dataset.category = category;
    editorOverlay.classList.add('visible');
    
    // Focus first input
    setTimeout(() => {
        const firstInput = editorBody.querySelector('input, select, textarea');
        if (firstInput) firstInput.focus();
    }, 300);
}

function closeFloatingEditor() { 
    editorOverlay.classList.remove('visible'); 
}

function saveEditorChanges() {
    const key = editorOverlay.dataset.key;
    const category = editorOverlay.dataset.category;
    
    editorBody.querySelectorAll('[data-path]').forEach(input => {
        const path = input.dataset.path.split('.');
        let value;
        
        if (input.type === 'checkbox') {
            value = input.checked;
        } else if (input.type === 'number') {
            value = parseFloat(input.value);
        } else if (input.tagName === 'TEXTAREA') {
            try {
                value = JSON.parse(input.value);
            } catch {
                value = input.value;
            }
        } else {
            value = input.value;
        }
        
        let current = jsonConfig;
        for (let i = 0; i < path.length - 1; i++) {
            current = current[path[i]];
        }
        
        if (input.tagName === 'SELECT' && value === 'custom') {
            const customInput = editorBody.querySelector(`[data-path="${input.dataset.path}-custom"]`);
            current[path[path.length - 1]] = [customInput.value];
        } else if (Array.isArray(current[path[path.length-1]])) {
             current[path[path.length-1]] = [value];
        } else {
            current[path[path.length - 1]] = value;
        }
    });
    
    // Update UI
    const settingRow = document.querySelector(`.setting-row[data-key="${key}"][data-category="${category}"]`);
    if (settingRow) {
        const valueDisplay = settingRow.querySelector('.setting-row-value');
        const {text, className} = getEnhancedSummaryText(key, jsonConfig[category][key], category);
        valueDisplay.textContent = text;
        valueDisplay.className = `setting-row-value ${className}`.trim();
    }
    
    closeFloatingEditor();
}

// Event Listeners
document.getElementById('editor-save-btn').onclick = saveEditorChanges;
document.getElementById('editor-cancel-btn').onclick = closeFloatingEditor;
editorOverlay.onclick = (e) => { if (e.target === editorOverlay) closeFloatingEditor(); };
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && editorOverlay.classList.contains('visible')) {
        closeFloatingEditor();
    }
});

function createEnhancedEditorControls(key, category) {
    const container = document.createElement('div');
    const value = jsonConfig[category][key];
    const isParent = allParentKeys.has(key);

    if (isParent) {
        container.appendChild(buildEnhancedParentEditor(key, category));
    } else {
        container.appendChild(buildEnhancedSimpleEditor(key, category));
    }
    
    return container;
}

function buildEnhancedParentEditor(key, category) {
    const container = document.createElement('div');
    const value = jsonConfig[category][key];
    const children = parentChildMap.get(key) || [];
    const dataPath = `${category}.${key}`;
    const isObjectType = typeof value === 'object' && value !== null && !Array.isArray(value);
    const isEnabled = isObjectType ? value.enabled : value;

    // Parent section
    const parentSection = document.createElement('div');
    parentSection.className = 'editor-parent-section';
    
    // Parent header with toggle
    const parentHeader = document.createElement('div');
    parentHeader.className = 'editor-parent-header';
    
    const toggleContainer = document.createElement('div');
    toggleContainer.className = 'editor-checkbox-row';
    toggleContainer.style.background = 'transparent';
    toggleContainer.style.border = 'none';
    toggleContainer.style.padding = '0';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'editor-parent-toggle';
    checkbox.checked = isEnabled;
    checkbox.dataset.path = isObjectType ? `${dataPath}.enabled` : dataPath;
    
    const label = document.createElement('label');
    label.textContent = `Enable ${formatLabel(key)}`;
    label.style.color = 'white';
    label.style.fontWeight = '600';
    
    // Update child settings visibility when parent changes
    checkbox.onchange = () => {
        const childContainer = parentSection.querySelector('.editor-child-settings');
        if (childContainer) {
            if (checkbox.checked) {
                childContainer.classList.remove('disabled');
            } else {
                childContainer.classList.add('disabled');
            }
        }
    };
    
    toggleContainer.appendChild(checkbox);
    toggleContainer.appendChild(label);
    parentHeader.appendChild(toggleContainer);
    
    // Child settings container
    const childSettings = document.createElement('div');
    childSettings.className = `editor-child-settings ${!isEnabled ? 'disabled' : ''}`;
    
    if (children.length > 0) {
        const childTitle = document.createElement('h4');
        childTitle.textContent = `‚öôÔ∏è ${formatLabel(key)} Options`;
        childTitle.style.marginTop = '0';
        childTitle.style.color = '#333';
        childSettings.appendChild(childTitle);
        
        children.forEach(childKey => {
            const childValue = isObjectType ? value[childKey] : jsonConfig[category][childKey];
            if (childValue !== undefined) {
                const childEditor = buildEnhancedSimpleEditor(
                    childKey, 
                    category, 
                    isObjectType ? `${dataPath}.${childKey}` : `${category}.${childKey}`
                );
                childEditor.style.marginBottom = '16px';
                childEditor.style.padding = '12px';
                childEditor.style.background = 'rgba(255,255,255,0.7)';
                childEditor.style.borderRadius = '6px';
                childEditor.style.border = '1px solid #e0e0e0';
                childSettings.appendChild(childEditor);
            }
        });
    }
    
    parentSection.appendChild(parentHeader);
    parentSection.appendChild(childSettings);
    container.appendChild(parentSection);
    
    return container;
}

function buildEnhancedSimpleEditor(key, category, customDataPath = null) {
    const container = document.createElement('div');
    container.className = 'editor-simple-setting';
    
    const dataPath = customDataPath || `${category}.${key}`;
    const value = getValueByPath(jsonConfig, dataPath.split('.'));
    
    // Setting label
    const label = document.createElement('label');
    label.className = 'editor-setting-label';
    label.innerHTML = `
        ${getSettingTypeIndicator(key, value)}
        <strong>${formatLabel(key)}</strong>
        ${getSettingDescription(key)}
    `;
    
    // Control container
    const controlContainer = document.createElement('div');
    controlContainer.style.marginTop = '12px';
    
    const control = createEnhancedInputControl(key, value, dataPath, category);
    controlContainer.appendChild(control);
    
    container.appendChild(label);
    container.appendChild(controlContainer);
    
    return container;
}

function createEnhancedInputControl(key, value, dataPath, category) {
    const originalOptions = getValueByPath(originalJsonConfig, `${category}.${key}`.split('.'));
    
    // Boolean input
    if (typeof value === 'boolean') {
        const container = document.createElement('div');
        container.className = 'editor-checkbox-row';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = value;
        checkbox.dataset.path = dataPath;
        
        const label = document.createElement('label');
        label.textContent = value ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
        
        checkbox.onchange = () => {
            label.textContent = checkbox.checked ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
        };
        
        container.appendChild(checkbox);
        container.appendChild(label);
        return container;
    }
    
    // Array input (dropdown + custom option)
    if (Array.isArray(value) || Array.isArray(originalOptions)) {
        const container = document.createElement('div');
        
        const select = document.createElement('select');
        select.dataset.path = dataPath;
        
        const currentValue = Array.isArray(value) ? value[0] : value;
        const isCustomValue = keysWithCustomOption.includes(key) && 
            Array.isArray(originalOptions) && 
            !originalOptions.includes(currentValue);
        
        // Add original options
        if (Array.isArray(originalOptions)) {
            originalOptions.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option;
                optionEl.textContent = formatOptionText(option);
                if (currentValue === option) optionEl.selected = true;
                select.appendChild(optionEl);
            });
        }
        
        // Add custom option if supported
        if (keysWithCustomOption.includes(key)) {
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'üé® Custom Value';
            if (isCustomValue) customOption.selected = true;
            select.appendChild(customOption);
        }
        
        // Custom input container
        const customContainer = document.createElement('div');
        customContainer.className = 'custom-input-container';
        customContainer.style.display = isCustomValue ? 'flex' : 'none';
        
        const customInput = document.createElement('input');
        customInput.type = 'text';
        customInput.placeholder = 'Enter custom value...';
        customInput.dataset.path = `${dataPath}-custom`;
        if (isCustomValue) customInput.value = currentValue;
        
        const generatableKeys = [
            'changeAndroidId', 'changeImei', 'changeImsi', 'changeAndroidSerial', 
            'changeWifiMacAddress', 'changeBluetoothMacAddress', 'changeEthernetMacAddress',
            'changeGoogleAdvertisingId', 'changeGoogleServiceFrameworkId',
            'changeFacebookAttributionId', 'changeAppSetId', 'changeOpenId', 
            'changeAmazonAdvertisingId', 'changeHuaweiAdvertisingId'
        ];
        
        // Generate button for ID-type fields
        if (generatableKeys.includes(key)) {
            const generateBtn = document.createElement('button');
            generateBtn.type = 'button';
            generateBtn.className = 'generate-btn';
            generateBtn.textContent = 'üé≤ Generate';
            generateBtn.onclick = () => {
                customInput.value = generateRandomValue(key);
            };
            customContainer.appendChild(customInput);
            customContainer.appendChild(generateBtn);
        } else {
            customContainer.appendChild(customInput);
        }
        
        // Toggle custom input visibility
        select.onchange = () => {
            customContainer.style.display = select.value === 'custom' ? 'flex' : 'none';
            if (select.value === 'custom') {
                setTimeout(() => customInput.focus(), 100);
            }
        };
        
        container.appendChild(select);
        container.appendChild(customContainer);
        return container;
    }
    
    // Number input
    if (typeof value === 'number') {
        const input = document.createElement('input');
        input.type = 'number';
        input.value = value;
        input.dataset.path = dataPath;
        input.step = Number.isInteger(value) ? '1' : '0.1';
        return input;
    }
    
    // Object/JSON input
    if (typeof value === 'object' && value !== null) {
        const textarea = document.createElement('textarea');
        textarea.value = JSON.stringify(value, null, 2);
        textarea.dataset.path = dataPath;
        textarea.placeholder = 'Enter valid JSON...';
        return textarea;
    }
    
    // Text input (default)
    const input = document.createElement('input');
    input.type = 'text';
    input.value = value || '';
    input.dataset.path = dataPath;
    input.placeholder = `Enter ${formatLabel(key).toLowerCase()}...`;
    return input;
}

// --- Enhanced Utility Functions ---
function getValueByPath(obj, path) {
    let current = obj;
    for (const key of path) {
        if (current && typeof current === 'object' && key in current) {
            current = current[key];
        } else {
            return undefined;
        }
    }
    return current;
}

function getSettingDescription(key) {
    const descriptions = {
        'changePackageName': '<br><small>üè∑Ô∏è Modify the app package identifier</small>',
        'changeAppName': '<br><small>üì± Change the display name of the app</small>',
        'changeAndroidId': '<br><small>üîë Unique device identifier</small>',
        'changeImei': '<br><small>üìû Mobile device identifier</small>',
        'hideAppIcon': '<br><small>üëÅÔ∏è Make app icon invisible in launcher</small>',
        'preventUninstall': '<br><small>üõ°Ô∏è Protect app from removal</small>',
        'disableAds': '<br><small>üö´ Block advertisement content</small>',
        'enableDebugMode': '<br><small>üêõ Enable development debugging</small>',
        'buildPropsEnablePlaceholders': '<br><small>üîÑ Use placeholders like [RANDOM] in fields above.</small>',
        'dnsOverHttpsUrl': '<br><small>üåê URL of the DNS-over-HTTPS provider (e.g., https://dns.google/dns-query).</small>'
    };
    return descriptions[key] || '';
}

function formatOptionText(option) {
    if (typeof option === 'boolean') return option ? '‚úÖ Yes' : '‚ùå No';
    if (typeof option === 'string' && option.length > 30) {
        return option.substring(0, 27) + '...';
    }
    return String(option);
}

function formatLabel(key) {
    return key.replace(/([A-Z])/g, ' $1')
              .replace(/^./, str => str.toUpperCase())
              .trim();
}

function generateRandomValue(key) {
    const generateMacAddress = () => Array.from({length: 6}, () =>
        Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
    ).join(':').toUpperCase();

    const generateUuid = () => {
        // Generates a valid v4 UUID
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    };

    const generateHex = (len) => Array.from({length: len}, () =>
        Math.floor(Math.random() * 16).toString(16)).join('');

    const generateDigits = (len) => Array.from({length: len}, () =>
        Math.floor(Math.random() * 10)).join('');

    const generators = {
        'changeAndroidId': () => generateHex(16),
        'changeImei': () => generateDigits(15),
        'changeImsi': () => generateDigits(15),
        'changeAndroidSerial': () => 'AC' + Array.from({length: 12}, () => Math.floor(Math.random() * 36).toString(36).toUpperCase()).join(''),
        'changeWifiMacAddress': generateMacAddress,
        'changeBluetoothMacAddress': generateMacAddress,
        'changeEthernetMacAddress': generateMacAddress,
        'changeGoogleAdvertisingId': generateUuid,
        'changeGoogleServiceFrameworkId': () => generateHex(16),
        'changeFacebookAttributionId': generateUuid,
        'changeAppSetId': generateUuid,
        'changeOpenId': generateUuid,
        'changeAmazonAdvertisingId': generateUuid,
        'changeHuaweiAdvertisingId': generateUuid,
    };
    
    const generator = generators[key];
    return generator ? generator() : `custom_${Date.now()}`;
}

// --- Enhanced Save Function ---
function getUpdatedConfig() {
    const flatConfig = {};

    for (const category in jsonConfig) {
        const settings = jsonConfig[category];
        for (const key in settings) {
            if (!settings.hasOwnProperty(key)) continue;

            // Skip child keys - they're handled by parents
            if (allChildKeys.has(key)) continue;

            const value = settings[key];
            const isObjectParent = typeof value === 'object' && value !== null && !Array.isArray(value);
            const isBooleanParent = allParentKeys.has(key) && typeof value === 'boolean';

            // Handle object parents
            if (isObjectParent) {
                if (value.enabled) {
                    flatConfig[key] = value;
                }
                continue;
            }

            // Handle boolean parents
            if (isBooleanParent) {
                if (value) {
                    flatConfig[key] = true;
                    // Add enabled children
                    const children = parentChildMap.get(key) || [];
                    children.forEach(childKey => {
                        if (settings[childKey] !== undefined) {
                            flatConfig[childKey] = settings[childKey];
                        }
                    });
                }
                continue;
            }

            // Handle simple settings
            const originalValue = originalJsonConfig[category]?.[key];
            if (keysWithCustomOption.includes(key) && Array.isArray(value) && 
                Array.isArray(originalValue) && value.length === 1 && 
                !originalValue.includes(value[0])) {
                flatConfig[key] = "CUSTOM";
                const customKeyName = 'custom' + key.charAt(6).toUpperCase() + key.slice(7);
                flatConfig[customKeyName] = value[0];
            } else if (Array.isArray(value)) {
                flatConfig[key] = value[0];
            } else {
                flatConfig[key] = value;
            }
        }
    }

    return flatConfig;
}

function saveConfig() {
    let packageName = currentPackageName;
    if (!packageName) {
        packageName = prompt("üì¶ Package name not detected. Please enter it:");
        if (!packageName) {
            alert("‚ùå Save cancelled: Package name required.");
            return;
        }
        updatePackageName(packageName);
    }
    
    try {
        const finalFlatConfig = getUpdatedConfig();
        const jsonString = JSON.stringify(finalFlatConfig);
        
        // Save button loading state
        const saveBtn = document.querySelector('.save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '‚è≥ Saving...';
        saveBtn.disabled = true;
        
        setTimeout(() => {
            if (window.Android && typeof window.Android.saveEncryptedConfig === 'function') {
                window.Android.saveEncryptedConfig(jsonString, packageName, configFileSplitCount);
                if (window.Android.showToast) {
                    window.Android.showToast("‚úÖ Configuration saved successfully!");
                }
            } else {
                console.warn("üåê Browser mode: Downloading config as JSON file.");
                const blob = new Blob([JSON.stringify(finalFlatConfig, null, 2)], { 
                    type: 'application/json;charset=utf-8' 
                });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${packageName}_cloneSettings.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                alert("üì• Configuration downloaded as JSON file!");
            }
            
            // Reset button
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }, 500);
        
    } catch (error) {
        alert(`‚ùå Save Error: ${error.message}`);
        console.error("Save Error:", error);
    }
}
</script>
</body>
</html>