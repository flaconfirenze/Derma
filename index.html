<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appcloner Maker - Enhanced Floating Editor</title>
    <style>
        :root {
          --primary-blue: #1a73e8;
          --hover-blue: #1557b0;
          --bg-gray: #f8f9fa;
          --border-gray: #dadce0;
          --success-green: #34a853;
          --warning-orange: #fbbc04;
          --error-red: #ea4335;
        }
        body {
          font-family: 'Roboto', sans-serif;
          margin: 0;
          padding: 16px;
          background: white;
        }
        /* Hides the package and split count info panel */
        #package-info {
            display: none !important;
        }
        .container {
          max-width: 800px;
          margin: 0 auto;
        }
        .category {
          margin-bottom: 24px;
          border: 1px solid var(--border-gray);
          border-radius: 8px;
        }
        .category-header {
          background: var(--primary-blue);
          color: white;
          padding: 12px 16px;
          border-radius: 8px 8px 0 0;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .category-content {
          padding: 8px;
          display: none;
        }
        .category-content.active {
          display: block;
        }
        .chevron { 
          transition: transform 0.3s; 
          font-size: 16px;
        }
        .chevron.active { transform: rotate(180deg); }

        /* Enhanced Setting Row */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .setting-row:last-child {
            border-bottom: none;
        }
        .setting-row:hover {
            background-color: var(--bg-gray);
            transform: translateX(4px);
        }
        .setting-row.has-children::before {
            content: 'üóÇÔ∏è';
            position: absolute;
            left: -8px;
            font-size: 12px;
            opacity: 0.6;
        }
        .setting-row-label {
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .setting-row-type-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--border-gray);
            color: #666;
            font-weight: normal;
        }
        .setting-row-value {
            font-size: 14px;
            color: #555;
            background-color: #eef2ff;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
            color: var(--primary-blue);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .setting-row-value.enabled { background-color: #e8f5e8; color: var(--success-green); }
        .setting-row-value.disabled { background-color: #ffebee; color: var(--error-red); }
        .setting-row-value.custom { background-color: #fff3e0; color: var(--warning-orange); }

        .save-btn {
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: var(--primary-blue);
          color: white;
          padding: 12px 24px;
          border-radius: 24px;
          border: none;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          z-index: 1000;
          transition: all 0.2s;
        }
        .save-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Enhanced Floating Editor */
        .floating-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            backdrop-filter: blur(4px);
        }
        .floating-editor-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .floating-editor-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        .floating-editor-overlay.visible .floating-editor-content {
            transform: scale(1) translateY(0);
        }
        .floating-editor-header {
            padding: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            color: #111;
            border-bottom: 2px solid var(--border-gray);
            background: linear-gradient(135deg, var(--bg-gray) 0%, #ffffff 100%);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .editor-close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: var(--error-red);
        }
        .floating-editor-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .floating-editor-footer {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            border-top: 2px solid var(--border-gray);
            background-color: var(--bg-gray);
            border-radius: 0 0 12px 12px;
        }
        .editor-footer-info {
            font-size: 12px;
            color: #666;
        }
        .editor-footer-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .editor-button {
            padding: 0.6rem 1.2rem;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background-color: transparent;
            color: var(--primary-blue);
        }
        .editor-button.primary {
            background-color: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        .editor-button:hover { 
            background-color: rgba(26, 115, 232, 0.1);
            border-color: var(--primary-blue);
        }
        .editor-button.primary:hover { 
            background-color: var(--hover-blue);
            transform: translateY(-1px);
        }

        /* Enhanced Editor Controls */
        .editor-setting { 
            margin-bottom: 24px; 
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            overflow: hidden;
        }
        .editor-setting-label { 
            display: block; 
            margin-bottom: 8px; 
            color: #333; 
            font-weight: 600;
            font-size: 15px;
        }
        .editor-parent-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border: 2px solid var(--primary-blue);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .editor-parent-header {
            background: var(--primary-blue);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .editor-parent-toggle {
            width: 20px;
            height: 20px;
        }
        .editor-child-settings {
            padding: 16px;
            border-left: 4px solid var(--primary-blue);
            margin-left: 12px;
            background: rgba(26, 115, 232, 0.02);
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }
        .editor-child-settings.disabled {
            opacity: 0.5;
            background: rgba(0,0,0,0.02);
            border-left-color: #ccc;
            pointer-events: none;
        }
        .editor-simple-setting {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 16px;
        }
        .editor-checkbox-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 8px;
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        .editor-checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: var(--primary-blue);
        }
        .editor-checkbox-row label {
            font-weight: 500;
            color: #333;
        }
        .editor-setting input[type="text"], 
        .editor-setting input[type="number"], 
        .editor-setting select, 
        .editor-setting textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.2s;
            font-family: inherit;
        }
        .editor-setting input:focus,
        .editor-setting select:focus,
        .editor-setting textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            outline: none;
        }
        .custom-input-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-top: 8px; 
        }
        .generate-btn { 
            padding: 10px 16px; 
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--hover-blue) 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            flex-shrink: 0;
            font-weight: 500;
            transition: all 0.2s;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        .editor-setting textarea { 
            min-height: 120px; 
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        .setting-type-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .type-parent { background: var(--primary-blue); }
        .type-boolean { background: var(--success-green); }
        .type-array { background: var(--warning-orange); }
        .type-string { background: #9c27b0; }
        .type-number { background: #ff5722; }
        
        #loading, #error-message { text-align: center; padding: 20px; }
        #error-message { 
            color: var(--error-red); 
            background: #ffebee; 
            border-radius: 8px;
            border-left: 4px solid var(--error-red);
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .setting-row {
            animation: fadeInUp 0.3s ease-out;
        }
    </style>
</head>
<body>

<div class="container">
  <div id="package-info">
    <p><strong>üì¶ Package:</strong> <span id="packageNameDisplay">Not detected</span></p>
    <p><strong>üî¢ Split Count:</strong> <span id="splitCountDisplay">101</span></p>
  </div>
  <div id="loading">‚è≥ Loading configuration...</div>
  <div id="error-message" class="error-message" style="display: none;"></div>
  <div id="config-container"></div>
  <button class="save-btn" onclick="saveConfig()">üíæ Save Settings</button>
</div>

<!-- Enhanced Floating Editor -->
<div id="floating-editor-overlay" class="floating-editor-overlay">
    <div id="floating-editor-content" class="floating-editor-content">
        <div id="floating-editor-header" class="floating-editor-header">
            <span id="floating-editor-title">Edit Setting</span>
            <button class="editor-close-btn" onclick="closeFloatingEditor()">&times;</button>
        </div>
        <div id="floating-editor-body" class="floating-editor-body"></div>
        <div id="floating-editor-footer">
            <div class="editor-footer-info" id="editor-info"></div>
            <div class="editor-footer-buttons">
                <button id="editor-cancel-btn" class="editor-button">Cancel</button>
                <button id="editor-save-btn" class="editor-button primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- Enhanced Constants and State ---
const BIN_ID = '67fe9e1f8960c979a585d694';
const API_KEY = '$2a$10$SgT4qoOKXP6CD4u1jPEpduwi.2NbrCqV2u71AaL7mGaW.77CmNU7u';
let jsonConfig = {};
let originalJsonConfig = {};
let currentPackageName = "";
let configFileSplitCount = 101;
let allChildKeys = new Set();
let allParentKeys = new Set();
let parentChildMap = new Map(); // Maps parent keys to their children

const keysWithCustomOption = [
    'changeAndroidId', 'changeImei', 'changeAndroidSerial', 'changeWifiMacAddress',
    'changeBluetoothMacAddress', 'changeImsi', 'changeGoogleAdvertisingId', 'changeGoogleServiceFrameworkId',
    'changeFacebookAttributionId', 'changeAppSetId', 'changeOpenId', 'changeAmazonAdvertisingId', 
    'changeHuaweiAdvertisingId', 'changeLocale', 'changeEthernetMacAddress'
];

const NON_INTERACTIVE_DIRECTORY_KEYS = ['addPermissions', 'addProviders', 'addReceivers','addServices','addActivities','stringsProperties','serialFormat'];

const CUSTOM_EDITORS = ['webViewUrlDataFilterList'];

// --- START: Manual setting groups ---
const compoundSettingsMap = new Map([
    ['dnsOverHttps', ['dnsOverHttpsCustomUrl', 'dnsOverHttpsSilent']],
    ['skipDialogsStrings', ['skipDialogsStacktraceStrings', 'skipDialogsMonitorStacktraces']]
]);
const compoundSettingChildren = new Set(
    Array.from(compoundSettingsMap.values()).flat()
);
// --- END: Manual setting groups ---


// --- Enhanced Initialization ---
document.addEventListener('DOMContentLoaded', loadConfiguration);

async function loadConfiguration() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error-message');
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { 'X-Master-Key': API_KEY }
        });
        if (!response.ok) throw new Error(`Failed to load configuration (Status: ${response.status})`);
        const data = await response.json();
        jsonConfig = data.record;
        originalJsonConfig = JSON.parse(JSON.stringify(jsonConfig));
        
        analyzeParentChildRelationships();
        renderConfiguration(jsonConfig);
    } catch (error) {
        errorEl.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
        errorEl.style.display = 'block';
        console.error("Configuration Load Error:", error);
    } finally {
        loadingEl.style.display = 'none';
    }
}

// --- Enhanced Parent-Child Analysis ---
function analyzeParentChildRelationships() {
    allChildKeys.clear();
    allParentKeys.clear();
    parentChildMap.clear();
    
    // Automatic detection rules
    for (const category in jsonConfig) {
        const settings = jsonConfig[category];
        
        for (const key in settings) {
            // Rule 1: Object parents (have properties including 'enabled')
            if (typeof settings[key] === 'object' && settings[key] !== null && !Array.isArray(settings[key])) {
                allParentKeys.add(key);
                const children = Object.keys(settings[key]).filter(childKey => childKey !== 'enabled');
                parentChildMap.set(key, children);
                children.forEach(child => allChildKeys.add(child));
            }
            
            // Rule 2: Boolean parents (boolean keys that are prefixes of other keys)
            if (typeof settings[key] === 'boolean') {
                const relatedKeys = [];
                for (const otherKey in settings) {
                    if (key !== otherKey && otherKey.startsWith(key) && 
                        otherKey.length > key.length &&
                        otherKey.charAt(key.length) === otherKey.charAt(key.length).toUpperCase()) {
                        relatedKeys.push(otherKey);
                    }
                }
                if (relatedKeys.length > 0) {
                    allParentKeys.add(key);
                    parentChildMap.set(key, relatedKeys);
                    relatedKeys.forEach(child => allChildKeys.add(child));
                }
            }
        }
    }

    // --- START: Manual registration for groups with inconsistent naming ---
    const manualBooleanParents = {
        'addSnow': 'snow',
        'pictureInPictureSupport': 'pictureInPicture'
    };
    
    const explicitParentChildGroups = {
        'randomizeBuildProps': [
            'filterDevicesDatabase', 'devicesDatabaseFilters', 'devicesDatabaseUseAndroidVersion',
            'devicesDatabaseSdkVersions', 'randomizeBuildPropsDeviceNamePrefix'
        ],
        'spoofLocation': [
            'latitude', 'longitude', 'spoofRandomLocation', 
            
        ]
    };

    const buildPropsParent = 'buildsProps';

    for (const category in jsonConfig) {
        const settings = jsonConfig[category];

        // Handle manual boolean parents by prefix
        for (const parentKey in manualBooleanParents) {
            if (settings.hasOwnProperty(parentKey)) {
                const prefix = manualBooleanParents[parentKey];
                const children = Object.keys(settings).filter(k => k.startsWith(prefix) && k !== parentKey);
                if (children.length > 0) {
                    allParentKeys.add(parentKey);
                    parentChildMap.set(parentKey, children);
                    children.forEach(child => allChildKeys.add(child));
                }
            }
        }

        // Handle manual parents by explicit child list
        for (const parentKey in explicitParentChildGroups) {
            if (settings.hasOwnProperty(parentKey)) {
                const children = explicitParentChildGroups[parentKey];
                allParentKeys.add(parentKey);
                // MERGE with existing children (e.g., from object-based detection)
                const existingChildren = parentChildMap.get(parentKey) || [];
                const allChildren = [...new Set([...existingChildren, ...children])];
                parentChildMap.set(parentKey, allChildren);
                allChildren.forEach(child => allChildKeys.add(child));
            }
        }

        // Handle buildProps
        if (settings.hasOwnProperty(buildPropsParent)) {
            const children = Object.keys(settings).filter(k => k.startsWith('buildProps'));
            if (children.length > 0) {
                allParentKeys.add(buildPropsParent);
                parentChildMap.set(buildPropsParent, children);
                children.forEach(child => allChildKeys.add(child));
            }
        }
    }
    // --- END: Manual registration ---
    
    console.log('üîç Analysis Complete:', {
        parents: Array.from(allParentKeys),
        children: Array.from(allChildKeys),
        relationships: Object.fromEntries(parentChildMap)
    });
}

// --- Android Bridge ---
function updatePackageName(packageName) {
    currentPackageName = packageName;
    document.getElementById('packageNameDisplay').textContent = packageName;
}
function updateSplitCount(count) {
    configFileSplitCount = count;
    document.getElementById('splitCountDisplay').textContent = count;
}

// --- Enhanced UI Rendering ---
function renderConfiguration(config) {
    const container = document.getElementById('config-container');
    container.innerHTML = '';

    Object.entries(config).forEach(([category, settings]) => {
        const categoryElement = document.createElement('div');
        categoryElement.className = 'category';
        
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<span>üìÅ ${formatLabel(category)}</span><span class="chevron">‚åµ</span>`;
        header.onclick = () => {
            content.classList.toggle('active');
            header.querySelector('.chevron').classList.toggle('active');
        };
        
        const content = document.createElement('div');
        content.className = 'category-content';
        
        // Only render main settings (parents, compound, and standalone settings)
        for (const key in settings) {
            if (Object.hasOwnProperty.call(settings, key) && 
                !allChildKeys.has(key) &&
                !compoundSettingChildren.has(key) &&
                !NON_INTERACTIVE_DIRECTORY_KEYS.includes(key)) {
                content.appendChild(createEnhancedSettingRow(key, settings[key], category));
            }
        }

        if (content.hasChildNodes()) {
            categoryElement.appendChild(header);
            categoryElement.appendChild(content);
            container.appendChild(categoryElement);
        }
    });
}

function createEnhancedSettingRow(key, value, category) {
    const row = document.createElement('div');
    row.className = 'setting-row';
    
    const isParent = allParentKeys.has(key);
    if (isParent || compoundSettingsMap.has(key) || CUSTOM_EDITORS.includes(key)) {
        row.classList.add('has-children');
    }
    
    row.dataset.key = key;
    row.dataset.category = category;
    row.onclick = () => openFloatingEditor(key, category);

    const label = document.createElement('div');
    label.className = 'setting-row-label';
    
    const typeIndicator = getSettingTypeIndicator(key, value);
    const typeBadge = getSettingTypeBadge(key, value);
    
    label.innerHTML = `
        ${typeIndicator}
        <span>${formatLabel(key)}</span>
        ${typeBadge}
    `;

    const valueDisplay = document.createElement('div');
    valueDisplay.className = 'setting-row-value';
    const {text, className} = getEnhancedSummaryText(key, value, category);
    valueDisplay.textContent = text;
    
    if (className) {
        valueDisplay.classList.add(className);
    }
    
    row.appendChild(label);
    row.appendChild(valueDisplay);
    return row;
}

function getSettingTypeIndicator(key, value) {
    if (allParentKeys.has(key) || compoundSettingsMap.has(key) || CUSTOM_EDITORS.includes(key)) return '<span class="setting-type-indicator type-parent"></span>';
    if (typeof value === 'boolean') return '<span class="setting-type-indicator type-boolean"></span>';
    if (Array.isArray(value)) return '<span class="setting-type-indicator type-array"></span>';
    if (typeof value === 'number') return '<span class="setting-type-indicator type-number"></span>';
    return '<span class="setting-type-indicator type-string"></span>';
}

function getSettingTypeBadge(key, value) {
    if (CUSTOM_EDITORS.includes(key)) {
        const count = Array.isArray(value) ? value.length : 0;
        return `<span class="setting-row-type-badge">‚ò∞ ${count} item(s)</span>`;
    }

    let childCount = 0;
    if (allParentKeys.has(key)) {
        childCount = parentChildMap.get(key)?.length || 0;
    } else if (compoundSettingsMap.has(key)) {
        childCount = compoundSettingsMap.get(key)?.length || 0;
    }

    if (childCount > 0) {
        return `<span class="setting-row-type-badge">üë• ${childCount + 1} options</span>`;
    }

    if (typeof value === 'boolean') return '<span class="setting-row-type-badge">‚è∞ Toggle</span>';
    if (Array.isArray(value)) return '<span class="setting-row-type-badge">üìã List</span>';
    if (typeof value === 'number') return '<span class="setting-row-type-badge">üî¢ Number</span>';
    return '<span class="setting-row-type-badge">üìù Text</span>';
}

function getEnhancedSummaryText(key, value, category) {
    if (CUSTOM_EDITORS.includes(key)) {
        const count = Array.isArray(value) ? value.length : 0;
        return { text: `${count} configured`, className: count > 0 ? 'enabled' : 'disabled' };
    }
    
    const isObjectParent = typeof value === 'object' && value !== null && !Array.isArray(value);
    const isBooleanParent = allParentKeys.has(key) && typeof value === 'boolean';
    
    if (isObjectParent) {
        return {
            text: value.enabled ? "‚úÖ Enabled" : "‚ùå Disabled",
            className: value.enabled ? "enabled" : "disabled"
        };
    }
    if (isBooleanParent) {
        return {
            text: value ? "‚úÖ Enabled" : "‚ùå Disabled", 
            className: value ? "enabled" : "disabled"
        };
    }
    
    if (typeof value === 'boolean') {
        return {
            text: value ? "üü¢ On" : "‚ö´ Off",
            className: value ? "enabled" : "disabled"
        };
    }

    if (Array.isArray(value)) {
        if (value.length === 0) return {text: "[0 items]", className: "disabled"};
        const originalOptions = originalJsonConfig[category]?.[key];
        if (keysWithCustomOption.includes(key) && Array.isArray(originalOptions) && 
            originalOptions.indexOf(value[0]) === -1) {
            return {text: "üé® Custom", className: "custom"};
        }
        if (typeof value[0] === 'string') {
            return {text: value[0], className: ""};
        }
        return {text: `[${value.length} items]`, className: ""};
    }
    
    if (typeof value === 'string' && value.length > 15) {
        return {text: value.substring(0, 12) + '...', className: ""};
    }
    
    return {text: value || 'Not set', className: value ? "" : "disabled"};
}

// --- Enhanced Floating Editor ---
const editorOverlay = document.getElementById('floating-editor-overlay');
const editorTitle = document.getElementById('floating-editor-title');
const editorBody = document.getElementById('floating-editor-body');
const editorInfo = document.getElementById('editor-info');

function openFloatingEditor(key, category) {
    const isParent = allParentKeys.has(key);
    const isCompound = compoundSettingsMap.has(key);
    const isCustom = CUSTOM_EDITORS.includes(key);
    let children = [];
    if (isParent) children = parentChildMap.get(key) || [];
    if (isCompound) children = compoundSettingsMap.get(key) || [];
    
    editorTitle.innerHTML = `
        ${getSettingTypeIndicator(key, jsonConfig[category][key])}
        <strong>${formatLabel(key)}</strong>
    `;
    
    editorInfo.textContent = (isParent || isCompound || isCustom) ? 
        `Grouped setting` : 
        'Simple setting';
    
    editorBody.innerHTML = '';
    editorBody.appendChild(createEnhancedEditorControls(key, category));
    editorOverlay.dataset.key = key;
    editorOverlay.dataset.category = category;
    editorOverlay.classList.add('visible');
    
    // Focus first input
    setTimeout(() => {
        const firstInput = editorBody.querySelector('input, select, textarea');
        if (firstInput) firstInput.focus();
    }, 300);
}

function closeFloatingEditor() { 
    editorOverlay.classList.remove('visible'); 
}

function saveEditorChanges() {
    const key = editorOverlay.dataset.key;
    const category = editorOverlay.dataset.category;
    
    // Custom editors like the WebView Filter update the model in real-time,
    // so no extra save logic is needed here for them.
    if (!CUSTOM_EDITORS.includes(key)) {
        editorBody.querySelectorAll('[data-path]').forEach(input => {
            const path = input.dataset.path.split('.');
            let value;
            
            if (input.dataset.type === 'array-textarea') {
                value = input.value.split('\n').map(s => s.trim()).filter(Boolean);
            } else if (input.type === 'checkbox') {
                value = input.checked;
            } else if (input.type === 'number') {
                value = input.value === '' ? '' : (parseFloat(input.value) || 0);
            } else if (input.tagName === 'TEXTAREA') {
                try {
                    value = JSON.parse(input.value);
                } catch {
                    value = input.value;
                }
            } else {
                value = input.value;
            }
            
            let current = jsonConfig;
            for (let i = 0; i < path.length - 1; i++) {
                current = current[path[i]];
            }
            
            const keyToUpdate = path[path.length - 1];

            if (input.dataset.type === 'array-textarea') {
                current[keyToUpdate] = value;
            } else if (input.tagName === 'SELECT' && value === 'custom') {
                const customInput = editorBody.querySelector(`[data-path="${input.dataset.path}-custom"]`);
                current[keyToUpdate] = [customInput.value];
            } else if (Array.isArray(current[keyToUpdate]) && !key.toLowerCase().includes('strings') && !key.toLowerCase().includes('filters')) {
                current[keyToUpdate] = [value];
            } else {
                current[keyToUpdate] = value;
            }
        });
    }
    
    // Update UI
    const settingRow = document.querySelector(`.setting-row[data-key="${key}"][data-category="${category}"]`);
    if (settingRow) {
        const valueDisplay = settingRow.querySelector('.setting-row-value');
        const {text, className} = getEnhancedSummaryText(key, jsonConfig[category][key], category);
        valueDisplay.textContent = text;
        valueDisplay.className = `setting-row-value ${className}`.trim();
    }
    
    closeFloatingEditor();
}

// Event Listeners
document.getElementById('editor-save-btn').onclick = saveEditorChanges;
document.getElementById('editor-cancel-btn').onclick = closeFloatingEditor;
editorOverlay.onclick = (e) => { if (e.target === editorOverlay) closeFloatingEditor(); };
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && editorOverlay.classList.contains('visible')) {
        closeFloatingEditor();
    }
});

function createEnhancedEditorControls(key, category) {
    const container = document.createElement('div');
    const isParent = allParentKeys.has(key);

    if (CUSTOM_EDITORS.includes(key)) {
        if (key === 'webViewUrlDataFilterList') {
            container.appendChild(buildWebViewFilterEditor(key, category));
        }
    } else if (compoundSettingsMap.has(key)) {
        container.appendChild(buildCompoundSettingEditor(key, category));
    } else if (isParent) {
        container.appendChild(buildEnhancedParentEditor(key, category));
    } else {
        container.appendChild(buildEnhancedSimpleEditor(key, category));
    }
    
    return container;
}

function buildWebViewFilterEditor(key, category) {
    const container = document.createElement('div');
    const list = jsonConfig[category][key] || [];

    const defaultFilter = {
        dataExpression: "", dataExpressionBlockOnMatch: false, dataExpressionIgnoreCase: false,
        dataReplacement: "", dataReplacementReplaceAll: false, urlExpression: "",
        urlExpressionBlockOnMatch: false, urlReplacement: "", urlReplacementUrlEncode: false
    };

    if (list.length === 0) {
        list.push({ ...defaultFilter });
    }

    let currentIndex = 0;

    const header = document.createElement('div');
    header.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;';
    
    const nav = document.createElement('div');
    nav.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';
    
    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‚óÄ';
    prevBtn.className = 'editor-button';

    const status = document.createElement('span');
    status.style.cssText = 'font-weight: 500; min-width: 50px; text-align: center;';
    
    const nextBtn = document.createElement('button');
    nextBtn.textContent = '‚ñ∂';
    nextBtn.className = 'editor-button';

    nav.append(prevBtn, status, nextBtn);

    const actions = document.createElement('div');
    actions.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';

    const addBtn = document.createElement('button');
    addBtn.textContent = '‚ûï';
    addBtn.className = 'editor-button';

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '‚ûñ';
    deleteBtn.className = 'editor-button';

    actions.append(addBtn, deleteBtn);
    header.append(nav, actions);

    const formContainer = document.createElement('div');

    const renderCurrentFilter = () => {
        formContainer.innerHTML = '';
        if (list.length === 0) {
            status.textContent = '0 / 0';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            deleteBtn.disabled = true;
            return;
        }

        status.textContent = `${currentIndex + 1} / ${list.length}`;
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === list.length - 1;
        deleteBtn.disabled = list.length === 0;

        const currentFilter = list[currentIndex];

        const createSection = (title) => {
            const section = document.createElement('div');
            section.style.marginBottom = '1rem';
            const h4 = document.createElement('h4');
            h4.textContent = title;
            h4.style.cssText = 'margin-top: 0; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-blue)';
            section.appendChild(h4);
            return section;
        };

        const createInput = (label, key, type = 'text') => {
            const setting = buildEnhancedSimpleEditor(label, category);
            const input = setting.querySelector('input');
            input.id = `filter-input-${key}`;
            input.value = currentFilter[key] || '';
            input.dataset.key = key;
            input.oninput = (e) => { currentFilter[key] = e.target.value; };
            return setting;
        };
        
        const createCheckbox = (label, key) => {
            const setting = buildEnhancedSimpleEditor(label, category);
            const checkbox = setting.querySelector('input');
            checkbox.type = 'checkbox';
            checkbox.id = `filter-input-${key}`;
            checkbox.checked = currentFilter[key] || false;
            checkbox.dataset.key = key;
            checkbox.onchange = (e) => { currentFilter[key] = e.target.checked; };
            return setting;
        };

        // URL Section
        const urlSection = createSection('URL');
        urlSection.appendChild(createInput('Regular expression', 'urlExpression'));
        urlSection.appendChild(createCheckbox('Block if matching', 'urlExpressionBlockOnMatch'));
        urlSection.appendChild(createInput('Replacement', 'urlReplacement'));
        urlSection.appendChild(createCheckbox('URL-encode replacement', 'urlReplacementUrlEncode'));
        
        // Data Section
        const dataSection = createSection('Data');
        dataSection.appendChild(createInput('Regular expression', 'dataExpression'));
        dataSection.appendChild(createCheckbox('Ignore case', 'dataExpressionIgnoreCase'));
        dataSection.appendChild(createCheckbox('Block if matching', 'dataExpressionBlockOnMatch'));
        dataSection.appendChild(createInput('Replacement', 'dataReplacement'));
        dataSection.appendChild(createCheckbox('Replace all', 'dataReplacementReplaceAll'));
        
        formContainer.append(urlSection, dataSection);
    };

    prevBtn.onclick = () => { if (currentIndex > 0) { currentIndex--; renderCurrentFilter(); } };
    nextBtn.onclick = () => { if (currentIndex < list.length - 1) { currentIndex++; renderCurrentFilter(); } };
    
    addBtn.onclick = () => {
        list.push({ ...defaultFilter });
        currentIndex = list.length - 1;
        renderCurrentFilter();
    };

    deleteBtn.onclick = () => {
        if (list.length > 0) {
            list.splice(currentIndex, 1);
            if (currentIndex >= list.length) {
                currentIndex = Math.max(0, list.length - 1);
            }
            if (list.length === 0) {
                 list.push({ ...defaultFilter });
                 currentIndex = 0;
            }
            renderCurrentFilter();
        }
    };

    container.append(header, formContainer);
    renderCurrentFilter();
    return container;
}


function buildCompoundSettingEditor(key, category) {
    const container = document.createElement('div');
    const children = compoundSettingsMap.get(key) || [];

    const mainEditor = buildEnhancedSimpleEditor(key, category);
    mainEditor.style.border = '2px solid var(--primary-blue)';
    container.appendChild(mainEditor);

    const optionsTitle = document.createElement('h4');
    optionsTitle.textContent = `‚öôÔ∏è Related Options`;
    optionsTitle.style.cssText = `margin-top: 24px; margin-bottom: 10px; color: #333; border-top: 1px solid var(--border-gray); padding-top: 16px;`;
    container.appendChild(optionsTitle);
    
    const childContainer = document.createElement('div');
    childContainer.style.cssText = `border-left: 4px solid var(--primary-blue); margin-left: 0; padding: 16px; background: rgba(26, 115, 232, 0.03); border-radius: 8px;`;
    
    children.forEach(childKey => {
        const childEditor = buildEnhancedSimpleEditor(childKey, category);
        childEditor.style.cssText = `margin-bottom: 16px; padding: 12px;`;
        childContainer.appendChild(childEditor);
    });
    if (childContainer.lastChild) childContainer.lastChild.style.marginBottom = '0';
    container.appendChild(childContainer);

    if (key === 'dnsOverHttps') {
        const mainSelect = mainEditor.querySelector('select');
        const customUrlEditor = container.querySelector(`[data-path="${category}.dnsOverHttpsCustomUrl"]`).closest('.editor-simple-setting');
        const toggleVisibility = () => { if (customUrlEditor) customUrlEditor.style.display = mainSelect.value.toUpperCase() === 'CUSTOM' ? 'block' : 'none'; };
        mainSelect.addEventListener('change', toggleVisibility);
        toggleVisibility();
    } else if (key === 'skipDialogsStrings') {
        const monitorCheckbox = container.querySelector(`[data-path="${category}.skipDialogsMonitorStacktraces"]`);
        const stacktraceTextarea = container.querySelector(`[data-path="${category}.skipDialogsStacktraceStrings"]`);
        const stacktraceEditor = stacktraceTextarea.closest('.editor-simple-setting');
        const toggleVisibility = () => {
            if (stacktraceEditor) {
                stacktraceEditor.style.transition = 'opacity 0.3s';
                stacktraceEditor.style.opacity = monitorCheckbox.checked ? '1' : '0.5';
                stacktraceTextarea.disabled = !monitorCheckbox.checked;
            }
        };
        monitorCheckbox.addEventListener('change', toggleVisibility);
        toggleVisibility();
    }
    
    return container;
}

function buildEnhancedParentEditor(key, category) {
    const container = document.createElement('div');
    const value = jsonConfig[category][key];
    const children = parentChildMap.get(key) || [];
    const dataPath = `${category}.${key}`;
    const isObjectType = typeof value === 'object' && value !== null && !Array.isArray(value);
    const isEnabled = isObjectType ? value.enabled : value;

    const parentSection = document.createElement('div');
    parentSection.className = 'editor-parent-section';
    
    const parentHeader = document.createElement('div');
    parentHeader.className = 'editor-parent-header';
    
    const toggleContainer = document.createElement('div');
    toggleContainer.className = 'editor-checkbox-row';
    toggleContainer.style.cssText = 'background: transparent; border: none; padding: 0;';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'editor-parent-toggle';
    checkbox.checked = isEnabled;
    checkbox.dataset.path = isObjectType ? `${dataPath}.enabled` : dataPath;
    
    const label = document.createElement('label');
    label.textContent = `Enable ${formatLabel(key)}`;
    label.style.cssText = 'color: white; font-weight: 600;';
    
    checkbox.onchange = () => {
        const childContainer = parentSection.querySelector('.editor-child-settings');
        if (childContainer) childContainer.classList.toggle('disabled', !checkbox.checked);
    };
    
    toggleContainer.appendChild(checkbox);
    toggleContainer.appendChild(label);
    parentHeader.appendChild(toggleContainer);
    
    const childSettings = document.createElement('div');
    childSettings.className = `editor-child-settings ${!isEnabled ? 'disabled' : ''}`;
    
    // --- SPECIAL UI FOR SPOOF LOCATION ---
    if (key === 'spoofLocation') {
        const coordsContainer = document.createElement('div');
        coordsContainer.style.marginBottom = '1rem';
        const latEditor = buildEnhancedSimpleEditor('latitude', category, `${category}.spoofLocationLatitude`);
        const lonEditor = buildEnhancedSimpleEditor('longitude', category, `${category}.spoofLocationLongitude`);
        latEditor.style.marginBottom = '1rem';
        lonEditor.style.marginBottom = 0;
        coordsContainer.append(latEditor, lonEditor);

        const mapImg = document.createElement('img');
        mapImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAwIDEwMDEiPjxwYXRoIGZpbGw9IiMwMDAiIGQ9Ik0xODM4LjIgNTkzLjVjLTIuMy0zLjItMy4xLTYuMS0zLjEtOC45IDAtMi40IDEuMS00LjkgMy4xLTcuMWwxLjEtMS4zYzIuNC0yLjggNS4xLTUuMSA3LjEtNi4zbDEuOC0xLjFjNS4yLTMuMyA4LjItMy42IDExLjItMS4zIDIuNyAyLjEgMy42IDUuNCAzLjEgOC45LS42IDMuNi0yLjUgNi45LTUuMSA5LjZsLTEuMyAxLjZjLTIuNSAzLTUuMiA1LjMtNy4yIDYuNWwtMS42LjljLTIuMi45LTQuNy43LTcuMS0uNGwtLjYtLjJ6bS0zMi45LTEwLjljLTIuNCAxLjMtNC45IDIuMi03LjUgMi41LTMuMy40LTYuNi0uNi05LjEtMi41LTIuOS0yLjItNC43LTUuNS01LjItOS4xLS42LTQuMS44LTcuOSAzLjUtMTAuNyAyLjQtMi41IDUuNS00IDkuMS00LjFsNy4xLS4yYzMuNSAwIDYuNiAxLjMgOC45IDMuNiAyLjUgMi41IDMuOSA1LjggMy42IDkuMy0uMyAzLjYtMiA2LjgtNC43IDkuMWwtMS4zIDEuM2MtLjYuNi0xLjMgMS4yLTIuMSAxLjdslC40LjN6TTEwMDAgMEM0NDcuNyAwIDAgNDQ3LjcgMCAxMDAwaDIwMDBDMjAwMCA0NDcuNyAxNTUyLjMgMCAxMDAwIDB6Ii8+PHBhdGggZmlsbD0iIzAwMCIgZD0iTTE3MTguMyAzOTIuMmMtMi40LTEuMi01LjEtMS44LTgtMS44LTQuMiAwLTcuNyAxLjYtMTAuNCA0LjEtMi45IDIuNy00LjcgNi4zLTUuMiAxMC40LS42IDQuNCAxIDguNSA0LjEgMTEuNSAyLjkgMi43IDYuOCA0LjIgMTAuOSA0LjEgNC40LS4xIDguMi0yIDExLjItNS4xIDIuOS0yLjkgNC43LTYuOCA1LjEtMTEuMi40LTQuNy0xLjItOS4xLTQuMS0xMi4ybC0zLjMtNC4zeiIvPjxwYXRoIGZpbGw9IiMwMDAiIGQ9Im0xNTQ3LjQgNTEzLjgtMy0xLjEtMi45LTIuOS0yLjktMi45Yy0yLjctMi45LTUtNS4yLTcuMS01LjJzLTQuMSAyLjMtNS44IDUuMmMtMS44IDIuOS0xLjUgNi4xLjkgOC45bDEuNiAxLjhjMi40IDIuNyA1LjIgNSA3LjcgNS4ybDMuMy4zYzIuNy4xIDUuMy0uOSA3LjQtMi44bDEuMy0xLjEuOS0xLjMuMS0xLjN6Ii8+PHBhdGggZmlsbD0iIzAwMCIgZD0iTTE2NzcuMiAzNjcuN2MtMTMtMi4xLTI0LjUgNC4zLTI5LjMgMTUuOS01LjEgMTIuNC40IDI2LjUgMTMuNCAzMS42IDEzIDUuMSAyNi41LS40IDMxLjYtMTMuNCA1LjEtMTIuNS0uNC0yNi41LTEzLjQtMzEuNmwtMi4zLTEuNXoiLz48cGF0aCBmaWxsPSIjMDAwIiBkPSJNMzYyLjQgNDk5LjhjLS45LTMuOS00LjEtNi44LTgtNy43LTQuMS0xLTguMi44LTEwLjcgNC4xcy0zLjUgNy41LTIuNSAxMS41YzEgNC4xIDQuMSA3LjEgOC4yIDcuOCA0LjEuOCA4LjItLjggMTAuNy00LjEgMi40LTMuNCAzLjQtNy41IDIuMy0xMS42eiIvPjxwYXRoIGZpbGw9IiMwMDAiIGQ9Ik0xMDY2LjggNDU5LjFjLTEuNi00LjQtNS44LTcuNC0xMC43LTcuNC00LjcgMC04LjggMi41LTEwLjkgNi42LTIuMyA0LjQtMS44IDkuMyAxLjIgMTIuNyAyLjkgMy41IDcuNCA1LjIgMTEuOCA0LjEgNC43LTEgOC41LTQuNCA5LjktOC45bC4zLTEuNmMuMy0xLjYuMy0zLjIuMy00LjlsLS4zLTEuMnpNMjA1LjUgMzk2LjljLTQuNC0yLjEtOS4zLTEuOC0xMy40IDEtNC4xIDIuNy02LjggNy4xLTcuMSAxMi4xLS4zIDUuMSAxLjggOS45IDUuOCAxMi43IDQuMSAyLjkgOS4zIDMuMyAxMy44IDEuMyA0LjQtMi4xIDcuNC02LjMsNy44LTExLjIuMy01LjEtMS44LTkuOS01LjgtMTIuN2wtMS4yLTMuMnoiLz48cGF0aCBmaWxsPSIjMDAwIiBkPSJtMTQwNS4zIDQwMC45LS45IDQuNGMtLjYgMy0xLjMgNi0yLjIgOC45bC0xLjMgNC40Yy0xLjggNS43LTQuNiAxMS04LjMgMTUuNmwtNS41IDYuNmMtMy42IDQuNC03LjggOC0xMi40IDEwLjdsLTYuMyAyLjctNi45IDIuNS0xMy42IDMuOS0xMC45IDIuMi0xMy4xIDEuMy0xMC45LS4yLTkuMS0xLjUtMTEuNS0zLjMtOS45LTUuMWwtNy43LTUuMi05LjEtNy4xLTQuNy00LjQtOS45LTEwLjQtNS41LTYuNi02LjEtOC4zLTQuNC02LjNjLTIuNy00LjEtNS04LjUtNi42LTEzLjFsLTEuOC01LjItMS42LTUuNS0xLjItNS41Yy0uMy0xLjgtLjYtMy42LS44LTUuNWwtLjMtNS44YzAtNC4xLjMtOC4zLjktMTIuNGwuOC01LjUgMS41LTYuMWMxLjItNC42IDIuOC04LjkgNS0xMy4xbDMuMi02YzIuNC00LjYgNS4yLTguOCA4LjYtMTIuN2w1L S5LjcgNS43LTYgNS43IDYuMy01LjIgNi4zLTQuNiA2LjMtMy44IDYuNi0zLjIgNi42LTIuNSA2LjYtMS42IDYuNi0uOCA2LjMuMiA2LjMuOSA2LjEgMS42IDYuMSAyLjUgNi4xIDMuNSA1LjggNC42IDUuOCA1LjIgNS41IDYuMyA1LjIgNy4xIDQuNyA4LjMgNC4xIDguOSAzLjUgOS4zIDIuOCA5LjkgMi4yIDEwLjEgMS41IDEwLjQuNiAxMC43LS4yIDEwLjktMS4xIDEwLjktMi4xIDEwLjktMy4yIDEwLjctNC40IDEwLjQtNS44IDkuOS03LjEgOS4zLTguNiA4LjUtMTAuMSA3LjctMTEuNSA2LjYtMTIuOSA1LjItMTQuNCAzLjgtMTUuOSAyLjMtMTcuNS44LTE4LjktLjktMjAuNC0yLjgtMjEuOC01LTIzLjEtNy4yLTI0LjQtOS44LTI1LjUtMTIuNS0xMi40LTI1LjItMTEuOC0yNy4xLTEwLjktMjguNy05LjktMzAuMS04LjYtMzEuMy03LjItMzIuNS01LjgtMzMuNS00LjMtMzQuNC0yLjctMzUuMy0xLTM2LjFsMS41IDNjMS4zIDIuNyAyLjQgNS41IDMuMiA4LjNsMS4xIDMuOGMxLjMgNC43IDIuMiA5LjYgMi41IDE0LjcuMyA1LjItLjIgMTAuNC0xLjIgMTUuM2wtMS44IDguNmMtMS4zIDYuMS0zLjYgMTEuOS02LjYgMTcuM2wtNC42IDcuOGMtMy4yIDUuMi03LjEgOS45LTExLjUgMTMuOWwtNi4zIDUuN2MtNC40IDMuOC05LjEgNi45LTE0LjEgOS4zbC02LjkgMy4zYy01IDIuMy0xMC4xIDMuOC0xNS4zIDQuNGwtNy4yLjgtNy4yLjItNy4xLS4zLTYuOS0uOS02LjgtMS41LTYuNi0yLjItNi4zLTMtNi4xLTMuOC01LjgtNC42LTUuNS01LjVjLTMuNi0zLjgtNi45LTgtOS45LTEyLjVsLTQuNC02LjgtNC40LTcuNC00LjEtNy44LTMuOC04LjMtMy41LTguOS0zLTkuNi0yLjctMTAuMS0yLjMtMTAuNy0yLTExLjItLjItMS4zLS4zLTIuNy0uMy00LjEgMC0yLjkuNS01LjggMS41LTguNWwxLjUtNC4xYzEuMi0zLjIgMi43LTYuMSA0LjYtOC44bDIuOC00LjFjMi0yLjkgNC4zLTUuNSA2LjgtNy44bDMuOC0zLjVjMi43LTIuMyA1LjctNC40IDguOC02LjFsNC42LTIuN2MzLTEuNiA2LjMtMi45IDkuNi0zLjhsNC45LTEuNWMzLjMtMSA2LjgtMS42IDEwLjItMS44bDUuMS0uNSA1LjIuMiA1LjEuOCA1IDEuMyA0LjkgMiA0LjcgMi41IDQuNiAzLjIgNC4zIDMuOSA0LjkgNC42IDMuNiA1LjIgMy4zIDYgMyA2LjYgMi43IDcuMiAyLjMgNy44IDIgOC41IDEuNiA5LjEuOSA5LjguMiAxMC40LS44IDEwLjktMS44IDExLjItMyAxMS41LTQuMyAxMS42LTUuNyAxMS44LTcuMiAxMS44LTguOCAxMS42LTEwLjQgMTEuMi0xMi4xIDEwLjctMTMuOCAxMC4xLTE1LjYgOS4zLTE3LjMgOC4zLTE4LjkgNy4yLTIwLjQgNi0yMS44IDQuNy0yMy4xIDMuMy0yNC40IDItMjUuNS41LTI2LjUtMS0yNy40LTIuNS0yOC4yLTQuMS0yOC44LTUuOC0yOS4zLTcuNy0yOS42LTkuNi0yOS44LTExLjUtMjkuOC0xMy40LTI5LjYtMTUuMy0yOS4zLTE3LjItMjguOC0xOS4xLTI4LjItMjAuOC0yNy40LTIyLjUtMjYuNS0yNC4xLTI1LjUtMjUuNS0yNC40LTI2LjgtMjMuMS0yNy45LTIxLjgtMjguOC0yMC40LTI5LjYtMTguOS0zMC4xLTE3LjMtMzAuNS0xNS42LTMwLjgtMTMuOC0zMC44LTEyLjEtMzAuOC0xMC4yLTMwLjUtOC41LTMwLjEtNi44LTI5LjYtNS0yOS0zLjItMjguMi0xLjMtMjcuNC41LTI2LjUgMi4zLTI1LjUgNC4xLTI0LjQgNi0yMy4xIDcuOC0yMS44IDkuNi0yMC40IDExLjItMTguOSAxMi43LTE3LjMgMTQuMS0xNS42IDE1LjMtMTMuOCAxNi40LTEyLjEgMTcuMy0xMC4yIDE4LjEtOC41IDE4LjgtNi44IDE5LjItNSAxOS41LTMuMiAxOS43LTEuMyAxOS43bC00LjEgNi4xeiIvPjwvc3ZnPg==';
        mapImg.style.cssText = 'width: 100%; border: 1px solid #ccc; background: #fff; border-radius: 8px; margin-bottom: 1rem;';

        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 8px; margin-bottom: 1rem;';
        
        const randomizeBtn = document.createElement('button');
        randomizeBtn.textContent = 'Randomize';
        randomizeBtn.type = 'button';
        randomizeBtn.className = 'editor-button primary';
        randomizeBtn.style.width = '100%';
        randomizeBtn.onclick = () => {
            const coords = generateRealisticCoordinates();
            const latInput = latEditor.querySelector('input');
            const lonInput = lonEditor.querySelector('input');
            latInput.value = coords.latitude;
            lonInput.value = coords.longitude;
            // Trigger change event to ensure data model is updated
            latInput.dispatchEvent(new Event('change', { bubbles: true }));
            lonInput.dispatchEvent(new Event('change', { bubbles: true }));
        };
        buttonContainer.append(randomizeBtn);

        const otherOptionsContainer = document.createElement('div');
        const hr = document.createElement('hr');
        hr.style.cssText = 'border: none; border-top: 1px solid var(--border-gray); margin: 1rem 0;';
        otherOptionsContainer.appendChild(hr);

        const randomLocEditor = buildEnhancedSimpleEditor('spoofRandomLocation', category);
        const randomCheckboxInput = randomLocEditor.querySelector('input[type="checkbox"]');
        randomCheckboxInput.addEventListener('change', () => {
            const disabled = randomCheckboxInput.checked;
            coordsContainer.style.opacity = disabled ? 0.5 : 1;
            coordsContainer.querySelectorAll('input').forEach(inp => inp.disabled = disabled);
        });
        setTimeout(() => randomCheckboxInput.dispatchEvent(new Event('change')), 0); // Initial check
        
        otherOptionsContainer.appendChild(randomLocEditor);
        
        children.filter(c => !['latitude', 'longitude', 'spoofRandomLocation'].includes(c))
            .forEach(childKey => {
                const childPath = (isObjectType && value[childKey] !== undefined) ? `${dataPath}.${childKey}` : `${category}.${childKey}`;
                otherOptionsContainer.appendChild(buildEnhancedSimpleEditor(childKey, category, childPath));
            });

        childSettings.append(coordsContainer, mapImg, buttonContainer, otherOptionsContainer);

    } else { // --- GENERIC UI FOR OTHER PARENTS ---
        if (children.length > 0) {
            const childTitle = document.createElement('h4');
            childTitle.textContent = `‚öôÔ∏è ${formatLabel(key)} Options`;
            childTitle.style.cssText = 'margin-top: 0; color: #333;';
            childSettings.appendChild(childTitle);
            
            children.forEach(childKey => {
                const isInternalChild = isObjectType && value.hasOwnProperty(childKey);
                const childValue = isInternalChild ? value[childKey] : jsonConfig[category][childKey];
                
                if (childValue !== undefined) {
                    const childDataPath = isInternalChild ? `${dataPath}.${childKey}` : `${category}.${childKey}`;
                    const childEditor = buildEnhancedSimpleEditor(childKey, category, childDataPath);
                    childEditor.style.cssText = 'margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px; border: 1px solid #e0e0e0;';
                    childSettings.appendChild(childEditor);
                }
            });
        }
    }
    
    parentSection.appendChild(parentHeader);
    parentSection.appendChild(childSettings);
    container.appendChild(parentSection);

    // Dynamic visibility for randomizeBuildProps
    if (key === 'randomizeBuildProps') {
        const filterDbCheckbox = childSettings.querySelector(`[data-path$=".filterDevicesDatabase"]`);
        const filtersEditor = childSettings.querySelector(`[data-path$=".devicesDatabaseFilters"]`)?.closest('.editor-simple-setting');
        const useVersionCheckbox = childSettings.querySelector(`[data-path$=".devicesDatabaseUseAndroidVersion"]`);
        const sdkVersionsEditor = childSettings.querySelector(`[data-path$=".devicesDatabaseSdkVersions"]`)?.closest('.editor-simple-setting');

        const toggleVisibility = (checkbox, editor) => {
            if (editor) {
                editor.style.transition = 'opacity 0.3s';
                editor.style.opacity = checkbox.checked ? '1' : '0.5';
                editor.querySelectorAll('input, textarea, select').forEach(el => el.disabled = !checkbox.checked);
            }
        };

        if (filterDbCheckbox && filtersEditor) {
            filterDbCheckbox.addEventListener('change', () => toggleVisibility(filterDbCheckbox, filtersEditor));
            toggleVisibility(filterDbCheckbox, filtersEditor);
        }
        if (useVersionCheckbox && sdkVersionsEditor) {
            useVersionCheckbox.addEventListener('change', () => toggleVisibility(useVersionCheckbox, sdkVersionsEditor));
            toggleVisibility(useVersionCheckbox, sdkVersionsEditor);
        }
    }
    
    return container;
}

function buildEnhancedSimpleEditor(key, category, customDataPath = null) {
    const container = document.createElement('div');
    container.className = 'editor-simple-setting';
    
    const dataPath = customDataPath || `${category}.${key}`;
    const value = getValueByPath(jsonConfig, dataPath.split('.'));
    
    const label = document.createElement('label');
    label.className = 'editor-setting-label';
    label.innerHTML = `${getSettingTypeIndicator(key, value)} <strong>${formatLabel(key)}</strong> ${getSettingDescription(key)}`;
    
    const controlContainer = document.createElement('div');
    controlContainer.style.marginTop = '12px';
    
    const control = createEnhancedInputControl(key, value, dataPath, category);
    controlContainer.appendChild(control);
    
    container.appendChild(label);
    container.appendChild(controlContainer);
    
    return container;
}

function createEnhancedInputControl(key, value, dataPath, category) {
    // Boolean
    if (typeof value === 'boolean') {
        const container = document.createElement('div');
        container.className = 'editor-checkbox-row';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = value;
        checkbox.dataset.path = dataPath;
        const label = document.createElement('label');
        label.textContent = value ? 'Enabled ‚úÖ' : 'Disabled ‚ùå';
        checkbox.onchange = () => { label.textContent = checkbox.checked ? 'Enabled ‚úÖ' : 'Disabled ‚ùå'; };
        container.append(checkbox, label);
        return container;
    }
    
    // Object of booleans (for SDK versions)
    if (key === 'devicesDatabaseSdkVersions' && typeof value === 'object' && value !== null && !Array.isArray(value)) {
        const sdkContainer = document.createElement('div');
        sdkContainer.style.cssText = 'padding: 10px; border: 1px solid #eee; border-radius: 8px;';
        for (const sdkVersion in value) {
            if (Object.hasOwnProperty.call(value, sdkVersion)) {
                const row = document.createElement('div');
                row.className = 'editor-checkbox-row';
                row.style.cssText = 'background: none; border: none; padding: 8px 0;';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = value[sdkVersion];
                checkbox.dataset.path = `${dataPath}.${sdkVersion}`;
                const label = document.createElement('label');
                label.textContent = `Android SDK ${sdkVersion}`;
                row.append(checkbox, label);
                sdkContainer.appendChild(row);
            }
        }
        return sdkContainer;
    }
    
    // Array of strings (for dialogs/filters)
    if (Array.isArray(value) && (key.toLowerCase().includes('strings') || key.toLowerCase().includes('filters'))) {
        const textarea = document.createElement('textarea');
        textarea.value = value.join('\n');
        textarea.dataset.path = dataPath;
        textarea.dataset.type = 'array-textarea';
        textarea.placeholder = 'Enter one item per line...';
        return textarea;
    }

    // Array of options (dropdown)
    const originalOptions = getValueByPath(originalJsonConfig, `${category}.${key}`.split('.'));
    if (Array.isArray(value) || Array.isArray(originalOptions)) {
        const container = document.createElement('div');
        const select = document.createElement('select');
        select.dataset.path = dataPath;
        const currentValue = Array.isArray(value) ? value[0] : value;
        const isCustomValue = keysWithCustomOption.includes(key) && Array.isArray(originalOptions) && !originalOptions.includes(currentValue);
        if (Array.isArray(originalOptions)) {
            originalOptions.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option;
                optionEl.textContent = formatOptionText(option);
                if (currentValue === option) optionEl.selected = true;
                select.appendChild(optionEl);
            });
        }
        if (keysWithCustomOption.includes(key)) {
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'üé® Custom Value';
            if (isCustomValue) customOption.selected = true;
            select.appendChild(customOption);
        }
        const customContainer = document.createElement('div');
        customContainer.className = 'custom-input-container';
        customContainer.style.display = isCustomValue ? 'flex' : 'none';
        const customInput = document.createElement('input');
        customInput.type = 'text';
        customInput.placeholder = 'Enter custom value...';
        customInput.dataset.path = `${dataPath}-custom`;
        if (isCustomValue) customInput.value = currentValue;
        const generatableKeys = ['changeAndroidId', 'changeImei', 'changeImsi', 'changeAndroidSerial', 'changeWifiMacAddress', 'changeBluetoothMacAddress', 'changeEthernetMacAddress','changeGoogleAdvertisingId', 'changeGoogleServiceFrameworkId','changeFacebookAttributionId', 'changeAppSetId', 'changeOpenId', 'changeAmazonAdvertisingId', 'changeHuaweiAdvertisingId'];
        if (generatableKeys.includes(key)) {
            const generateBtn = document.createElement('button');
            generateBtn.type = 'button';
            generateBtn.className = 'generate-btn';
            generateBtn.textContent = 'üé≤ Generate';
            generateBtn.onclick = () => { customInput.value = generateRandomValue(key); };
            customContainer.append(customInput, generateBtn);
        } else {
            customContainer.appendChild(customInput);
        }
        select.onchange = () => {
            customContainer.style.display = select.value === 'custom' ? 'flex' : 'none';
            if (select.value === 'custom') setTimeout(() => customInput.focus(), 100);
        };
        container.append(select, customContainer);
        return container;
    }
    
    // Number (including lat/lon)
    if (typeof value === 'number' || key.toLowerCase().includes('latitude') || key.toLowerCase().includes('longitude')) {
        const input = document.createElement('input');
        input.type = 'number';
        input.value = value;
        input.dataset.path = dataPath;
        input.step = 'any';
        return input;
    }
    
    // Object/JSON
    if (typeof value === 'object' && value !== null) {
        const textarea = document.createElement('textarea');
        textarea.value = JSON.stringify(value, null, 2);
        textarea.dataset.path = dataPath;
        textarea.placeholder = 'Enter valid JSON...';
        return textarea;
    }
    
    // Text (default)
    const input = document.createElement('input');
    input.type = 'text';
    input.value = value || '';
    input.dataset.path = dataPath;
    input.placeholder = `Enter ${formatLabel(key).toLowerCase()}...`;
    return input;
}

// --- Enhanced Utility Functions ---
function getValueByPath(obj, path) {
    return path.reduce((current, key) => (current && typeof current === 'object' && key in current) ? current[key] : undefined, obj);
}

function getSettingDescription(key) {
    const descriptions = {
        'dnsOverHttpsCustomUrl': '<br><small>üåê URL for the custom DNS provider.</small>',
    };
    return descriptions[key] || '';
}

function formatOptionText(option) {
    if (typeof option === 'boolean') return option ? '‚úÖ Yes' : '‚ùå No';
    return String(option).length > 30 ? String(option).substring(0, 27) + '...' : String(option);
}

function formatLabel(key) {
    return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim();
}

function generateRealisticCoordinates() {
    const landmasses = [
        { name: 'Europe', lat: [36, 71], lon: [-25, 65] },
        { name: 'Asia', lat: [-11, 82], lon: [25, 180] },
        { name: 'Africa', lat: [-35, 38], lon: [-18, 52] },
        { name: 'North America', lat: [5, 84], lon: [-168, -52] },
        { name: 'South America', lat: [-56, 13], lon: [-82, -34] },
        { name: 'Australia', lat: [-44, -10], lon: [112, 154] }
    ];

    const region = landmasses[Math.floor(Math.random() * landmasses.length)];
    
    const latitude = Math.random() * (region.lat[1] - region.lat[0]) + region.lat[0];
    const longitude = Math.random() * (region.lon[1] - region.lon[0]) + region.lon[0];

    return {
        latitude: latitude.toFixed(6),
        longitude: longitude.toFixed(6)
    };
}

function generateRandomValue(key) {
    const generateMacAddress = () => Array.from({length: 6}, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join(':').toUpperCase();
    const generateUuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });
    const generateHex = len => Array.from({length: len}, () => Math.floor(Math.random() * 16).toString(16)).join('');
    const generateDigits = len => Array.from({length: len}, () => Math.floor(Math.random() * 10)).join('');
    const generators = {
        'changeAndroidId': () => generateHex(16), 'changeImei': () => generateDigits(15), 'changeImsi': () => generateDigits(15),
        'changeAndroidSerial': () => 'AC' + Array.from({length: 12}, () => Math.floor(Math.random() * 36).toString(36).toUpperCase()).join(''),
        'changeWifiMacAddress': generateMacAddress, 'changeBluetoothMacAddress': generateMacAddress, 'changeEthernetMacAddress': generateMacAddress,
        'changeGoogleAdvertisingId': generateUuid, 'changeGoogleServiceFrameworkId': () => generateHex(16), 'changeFacebookAttributionId': generateUuid,
        'changeAppSetId': generateUuid, 'changeOpenId': generateUuid, 'changeAmazonAdvertisingId': generateUuid, 'changeHuaweiAdvertisingId': generateUuid,
    };
    return generators[key] ? generators[key]() : `custom_${Date.now()}`;
}

// --- Enhanced Save Function ---
function getUpdatedConfig() {
    const flatConfig = {};
    for (const category in jsonConfig) {
        const settings = jsonConfig[category];
        for (const key in settings) {
            if (!settings.hasOwnProperty(key)) continue;

            if (NON_INTERACTIVE_DIRECTORY_KEYS.includes(key)) {
                flatConfig[key] = originalJsonConfig[category][key]; 
                continue;
            }

            if (allChildKeys.has(key) && !compoundSettingsMap.has(key)) continue;

            const value = settings[key];
            const isObjectParent = typeof value === 'object' && value !== null && !Array.isArray(value);
            const isBooleanParent = allParentKeys.has(key) && typeof value === 'boolean';

            if (isObjectParent) {
                if (value.enabled) {
                    flatConfig[key] = value;
                    const externalChildren = (parentChildMap.get(key) || []).filter(c => !value.hasOwnProperty(c));
                    if (externalChildren.length > 0) {
                        externalChildren.forEach(childKey => {
                            if (settings[childKey] !== undefined) flatConfig[childKey] = settings[childKey];
                        });
                    }
                }
                continue;
            }
            if (isBooleanParent) {
                if (value) {
                    flatConfig[key] = true;
                    const children = parentChildMap.get(key) || [];
                    children.forEach(childKey => { if (settings[childKey] !== undefined) flatConfig[childKey] = settings[childKey]; });
                }
                continue;
            }
            if (compoundSettingsMap.has(key)) {
                flatConfig[key] = Array.isArray(value) ? value[0] : value;
                const children = compoundSettingsMap.get(key) || [];
                children.forEach(childKey => { if (settings[childKey] !== undefined) flatConfig[childKey] = settings[childKey]; });
                continue;
            }

            const originalValue = originalJsonConfig[category]?.[key];
            if (keysWithCustomOption.includes(key) && Array.isArray(value) && Array.isArray(originalValue) && value.length === 1 && !originalValue.includes(value[0])) {
                flatConfig[key] = "CUSTOM";
                flatConfig['custom' + key.charAt(6).toUpperCase() + key.slice(7)] = value[0];
            } else if (Array.isArray(value) && !key.toLowerCase().includes('strings') && !key.toLowerCase().includes('filters') && key !== 'webViewUrlDataFilterList') {
                flatConfig[key] = value[0];
            } else {
                flatConfig[key] = value;
            }
        }
    }
    return flatConfig;
}

function saveConfig() {
    let packageName = currentPackageName;
    if (!packageName) {
        packageName = prompt("üì¶ Package name not detected. Please enter it:");
        if (!packageName) { alert("‚ùå Save cancelled: Package name required."); return; }
        updatePackageName(packageName);
    }
    try {
        const finalFlatConfig = getUpdatedConfig();
        const jsonString = JSON.stringify(finalFlatConfig);
        const saveBtn = document.querySelector('.save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '‚è≥ Saving...';
        saveBtn.disabled = true;
        setTimeout(() => {
            if (window.Android && typeof window.Android.saveEncryptedConfig === 'function') {
                window.Android.saveEncryptedConfig(jsonString, packageName, configFileSplitCount);
                if (window.Android.showToast) window.Android.showToast("‚úÖ Configuration saved successfully!");
            } else {
                console.warn("üåê Browser mode: Downloading config as JSON file.");
                const blob = new Blob([JSON.stringify(finalFlatConfig, null, 2)], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${packageName}_cloneSettings.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                alert("üì• Configuration downloaded as JSON file!");
            }
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }, 500);
    } catch (error) {
        alert(`‚ùå Save Error: ${error.message}`);
        console.error("Save Error:", error);
    }
}
</script>
</body>
</html>