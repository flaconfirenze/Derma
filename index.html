<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale: 1.0">
    <title>Appcloner Maker</title>
    <style>
        :root {
          --primary-blue: #1a73e8;
          --hover-blue: #1557b0;
          --bg-gray: #f8f9fa;
          --border-gray: #dadce0;
        }

        body {
          font-family: 'Roboto', sans-serif;
          margin: 0;
          padding: 16px;
          background: white;
        }

        .container {
          max-width: 800px;
          margin: 0 auto;
        }

        .category {
          margin-bottom: 24px;
          border: 1px solid var(--border-gray);
          border-radius: 8px;
        }

        .category-header {
          background: var(--primary-blue);
          color: white;
          padding: 12px 16px;
          border-radius: 8px 8px 0 0;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .category-content {
          padding: 16px;
          display: none;
        }

        .category-content.active {
          display: block;
        }

        .setting-group {
          margin-bottom: 20px;
          padding: 15px;
          background-color: #f5f5f5;
          border-radius: 8px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        .setting-group h3 {
          margin-top: 0;
          margin-bottom: 15px;
          color: var(--primary-blue);
          font-size: 18px;
          font-weight: 500;
        }

        .setting-group .setting {
          margin-left: 15px;
          margin-bottom: 12px;
        }

        .setting {
          margin-bottom: 12px;
        }

        .setting-label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: 500;
        }

        .setting select {
          width: 100%;
          padding: 12px;
          border: 1px solid var(--border-gray);
          border-radius: 4px;
          font-size: 14px;
          background: white;
          cursor: pointer;
          appearance: none;
          -webkit-appearance: none;
          background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a73e8'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
          background-repeat: no-repeat;
          background-position: right 12px center;
          background-size: 20px;
          transition: border-color 0.2s, box-shadow 0.2s;
        }

        .setting select:hover {
          border-color: var(--primary-blue);
        }

        .setting select:focus {
          outline: none;
          border-color: var(--primary-blue);
          box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .setting select option {
          padding: 12px;
          font-size: 14px;
        }

        .setting input[type="text"],
        .setting input[type="number"] {
          width: 100%;
          padding: 8px;
          border: 1px solid var(--border-gray);
          border-radius: 4px;
          font-size: 14px;
          box-sizing: border-box;
        }

        .setting input[type="checkbox"] {
          margin-right: 8px;
        }

        .array-field {
          border-left: 3px solid var(--primary-blue);
          padding: 16px;
          margin: 12px 0;
          background: white;
          border-radius: 0 4px 4px 0;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .array-field .setting-label {
          color: var(--primary-blue);
          font-size: 15px;
          font-weight: 500;
          margin-bottom: 12px;
        }

        .array-field select {
          background-color: var(--bg-gray);
        }

        .array-field:hover {
          border-left-color: var(--hover-blue);
          background-color: var(--bg-gray);
          transition: all 0.2s ease;
        }

        .save-btn {
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: var(--primary-blue);
          color: white;
          padding: 12px 24px;
          border-radius: 24px;
          border: none;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          z-index: 1000;
        }

        .chevron {
          transition: transform 0.3s;
        }
        .chevron.active {
          transform: rotate(180deg);
        }

        #loading {
          display: none;
          text-align: center;
          padding: 20px;
        }

        .error-message {
          color: #d32f2f;
          padding: 10px;
          margin: 10px 0;
          border-radius: 4px;
          background: #ffebee;
          display: none;
        }

        .setting-checkbox {
          position: relative;
          display: flex;
          align-items: center;
          padding: 12px;
          background: var(--bg-gray);
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .setting-checkbox:hover {
          background: #eef2ff;
        }

        .setting-checkbox input[type="checkbox"] {
          position: absolute;
          opacity: 0;
          cursor: pointer;
          height: 0;
          width: 0;
        }

        .checkmark {
          position: relative;
          height: 24px;
          width: 48px;
          background-color: #ccc;
          border-radius: 12px;
          transition: all 0.3s ease;
          flex-shrink: 0;
        }

        .checkmark:before {
          content: '';
          position: absolute;
          height: 20px;
          width: 20px;
          left: 2px;
          bottom: 2px;
          background-color: white;
          border-radius: 50%;
          transition: all 0.3s ease;
        }

        .setting-checkbox input:checked ~ .checkmark {
          background-color: var(--primary-blue);
        }

        .setting-checkbox input:checked ~ .checkmark:before {
          transform: translateX(24px);
        }

        .setting-checkbox .toggle-label {
          margin-left: 12px;
          font-weight: 500;
          color: #333;
          flex-grow: 1;
        }

        .setting-checkbox .toggle-status {
          margin-left: auto;
          font-size: 14px;
          color: #666;
          white-space: nowrap;
          padding-left: 10px;
        }

        .slider-container {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .slider-value {
          min-width: 48px;
          padding: 4px 8px;
          background: var(--primary-blue);
          color: white;
          border-radius: 4px;
          text-align: center;
          font-size: 14px;
          white-space: nowrap;
        }

        input[type="range"] {
          flex-grow: 1;
          height: 4px;
          background: var(--border-gray);
          border-radius: 2px;
          appearance: none;
        }
        .array-container {
            margin-bottom: 15px;
        }

        .array-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .array-item input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .object-item {
            flex-wrap: wrap;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .object-field {
            display: flex;
            flex-direction: column;
            margin-right: 15px;
            margin-bottom: 5px;
        }

        .object-field label {
            margin-bottom: 2px;
            font-size: 12px;
            color: #666;
        }

        .add-item, .add-complex-item, .remove-item {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .remove-item {
            background-color: #d32f2f;
        }

        .add-item:hover, .add-complex-item:hover, .remove-item:hover {
            opacity: 0.8;
        }
        input[type="range"]::-webkit-slider-thumb {
          appearance: none;
          width: 16px;
          height: 16px;
          background: var(--primary-blue);
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
          transform: scale(1.2);
          background: var(--hover-blue);
        }

        /* Hide child settings initially */
        .child-settings-container {
            display: none;
            margin-left: 20px; /* Indent child settings */
            margin-top: 10px; /* Space below parent toggle */
            padding-left: 15px; /* Further indent content */
            border-left: 2px solid var(--border-gray); /* Visual cue */
        }

        .child-settings-container.active {
            display: block;
        }
        .child-setting {
            margin-bottom: 15px; /* Space between child settings */
        }

        #package-info {
          display: none;
        }

        .custom-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .custom-input-container .custom-input {
            flex-grow: 1;
            margin-top: 0;
            width: auto;
            margin-bottom: 0 !important;
        }

        .generate-btn {
            padding: 8px 12px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .generate-btn:hover {
            background-color: var(--hover-blue);
        }

        .array-field .custom-input-container input[type="text"] {
            width: auto;
        }

        /* String Array Editor (for empty arrays) & Directory List共通のスタイル調整 */
        .string-array-editor,
        .directory-list-container {
            margin-bottom: 16px;
            border-left: 4px solid var(--primary-blue);
            padding-left: 12px;
            background: #f9f9f9;
            border-radius: 0 4px 4px 0;
        }

        .string-array-editor-header,
        .directory-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 0;
        }
        .string-array-editor-header:hover,
        .directory-list-header:hover {
            background-color: #f0f0f0;
        }

        .string-array-editor-name,
        .directory-name {
            font-weight: 500;
            color: var(--primary-blue);
            flex-grow: 1;
        }

        .string-array-options-count,
        .options-count {
            margin-left: 8px;
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }

        .string-array-dropdown-arrow,
        .dropdown-arrow {
            transition: transform 0.3s;
            padding: 0 8px;
        }

        .string-array-dropdown-arrow.expanded,
        .dropdown-arrow.expanded {
            transform: rotate(180deg);
        }

        .string-array-editor-content,
        .directory-list-content {
            padding: 12px 0 12px 16px;
            display: none;
            border-top: 1px solid #eee;
            margin-top: 8px;
        }

        .string-array-editor-content.active,
        .directory-list-content.active {
            display: block;
        }

        .string-array-textarea,
        .directory-textarea {
            width: 100%;
            min-height: 100px;
            padding: 8px 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 14px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .string-array-help-text,
        .directory-help-text {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }

        .string-array-buttons,
        .directory-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .string-array-btn,
        .directory-btn {
            background: none;
            border: none;
            color: var(--primary-blue);
            font-weight: 500;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px;
        }

        .string-array-btn:hover,
        .directory-btn:hover {
            background-color: rgba(26, 115, 232, 0.1);
        }

        .string-array-btn.primary,
        .directory-btn.primary {
            background-color: var(--primary-blue);
            color: white;
        }

        .string-array-btn.primary:hover,
        .directory-btn.primary:hover {
            background-color: var(--hover-blue);
        }

        /* Styles for customCode and fridaScript textareas */
        .setting textarea.code-input {
          width: 100%;
          min-height: 120px;
          padding: 10px 12px;
          border: 1px solid var(--border-gray);
          border-radius: 4px;
          font-size: 14px;
          font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
          resize: vertical;
          margin-bottom: 8px;
          box-sizing: border-box;
          line-height: 1.5;
        }

        .setting textarea.code-input:hover {
          border-color: var(--primary-blue);
        }

        .setting textarea.code-input:focus {
          outline: none;
          border-color: var(--primary-blue);
          box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

    </style>
</head>
<body>
<div class="container">
  <div id="package-info" style="display: none;">
    <p>Package Name: <span id="packageNameDisplay">Not detected yet</span></p>
    <p>Split Count: <span id="splitCountDisplay">101 (default)</span></p>
  </div>

  <div id="loading">Loading configuration...</div>
  <div id="error-message" class="error-message"></div>

  <div id="config-container"></div>

  <button class="save-btn" onclick="saveConfig()">Save Settings</button>
</div>

<script>
// Constants for API access
const BIN_ID = '67fe9e1f8960c979a585d694';
const API_KEY = '$2a$10$SgT4qoOKXP6CD4u1jPEpduwi.2NbrCqV2u71AaL7mGaW.77CmNU7u';

const NON_INTERACTIVE_DIRECTORY_KEYS = ['addPermissions', 'addProviders', 'addReceivers','addServices','addActivities','stringsProperties','serialFormat'];

let jsonConfig = {};
let currentPackageName = "";
let configFileSplitCount = 101;

document.addEventListener('DOMContentLoaded', loadConfiguration);

async function loadConfiguration() {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const container = document.getElementById('config-container');
    loading.style.display = 'block';
    errorMessage.style.display = 'none';
    container.innerHTML = '';

    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { 'X-Master-Key': API_KEY }
        });
        if (!response.ok) throw new Error(`Failed to load configuration (Status: ${response.status})`);
        const data = await response.json();
        jsonConfig = data.record;
        renderConfiguration(jsonConfig);
        initializeEventListeners();
    } catch (error) {
        errorMessage.textContent = `Error: ${error.message}`;
        errorMessage.style.display = 'block';
        console.error("Configuration Load Error:", error);
        if (window.Android) window.Android.showToast(`Failed to load config: ${error.message}`);
    } finally {
        loading.style.display = 'none';
    }
}

function generateConfig() { return getUpdatedConfig(); }
function updatePackageName(packageName) {
    currentPackageName = packageName;
    const el = document.getElementById('packageNameDisplay');
    if (el) el.textContent = packageName;
    if (window.Android) window.Android.showToast("Package name updated: " + packageName);
}
function updateSplitCount(count) {
    configFileSplitCount = count;
    const el = document.getElementById('splitCountDisplay');
    if (el) el.textContent = count;
    if (window.Android) window.Android.showToast("Split count updated: " + count);
}

function renderConfiguration(config) {
    const container = document.getElementById('config-container');
    container.innerHTML = '';
    Object.entries(config).forEach(([category, settings]) => {
        const filteredSettings = Object.fromEntries(
            Object.entries(settings).filter(([key]) => !NON_INTERACTIVE_DIRECTORY_KEYS.includes(key) && key !== 'fakeWifiNetworks')
        );
        if (Object.keys(filteredSettings).length > 0) {
            const categoryElement = createCategorySection(category, filteredSettings);
            container.appendChild(categoryElement);
        }
    });
}

function createCategorySection(category, settings) {
    const section = document.createElement('div');
    section.className = 'category';
    const header = document.createElement('div');
    header.className = 'category-header';
    header.innerHTML = `<span>${formatLabel(category)}</span><span class="chevron">⌵</span>`;
    const content = document.createElement('div');
    content.className = 'category-content';

    let settingKeys = Object.keys(settings);
    for (let i = 0; i < settingKeys.length; i++) {
        const key = settingKeys[i];
        if (isChildSetting(key, settingKeys, settings)) continue;
        const value = settings[key];
        const settingElement = createSettingElement(key, value, category, settings);
        if (settingElement) content.appendChild(settingElement);
    }
    section.appendChild(header);
    section.appendChild(content);
    return section;
}

function isChildSetting(childKeyToCheck, allKeysInCategoryAsArray, allSettingsInCategoryObject) {
    if (childKeyToCheck === 'fakeCalculatorCode' && allKeysInCategoryAsArray.includes('fakeCalculator')) {
        return true;
    }
    if ((childKeyToCheck === 'appPatternSize' || childKeyToCheck === 'appPattern') && allKeysInCategoryAsArray.includes('patternLockApp')) {
        return true;
    }

    for (const parentKey of allKeysInCategoryAsArray) {
        if (childKeyToCheck !== parentKey && childKeyToCheck.startsWith(parentKey)) {
            const suffix = childKeyToCheck.substring(parentKey.length);
            if (typeof allSettingsInCategoryObject[parentKey] === 'boolean' &&
                suffix && (suffix[0] === suffix[0].toUpperCase() || !isNaN(parseInt(suffix[0])) || suffix === 'Value')) {
                 return true;
            }
        }
    }
    return false;
}

function createSettingElement(key, value, category, allSettingsInCategory) {
    if (NON_INTERACTIVE_DIRECTORY_KEYS.includes(key) || key === 'fakeWifiNetworks') return null;

    const setting = document.createElement('div');
    const dataPath = `${category}.${key}`;
    const formattedLabel = formatLabel(key);

    if (Array.isArray(value) && value.length === 0) {
        setting.className = 'string-array-editor setting';
        const uniqueId = `${category}-${key}-${Date.now()}`;
        setting.innerHTML = `
            <div class="string-array-editor-header" data-target-content="content-${uniqueId}" data-target-arrow="arrow-${uniqueId}">
                <span class="string-array-editor-name">${formattedLabel}</span>
                <span class="string-array-options-count" id="count-${uniqueId}">Options: 0</span>
                <span class="string-array-dropdown-arrow chevron" id="arrow-${uniqueId}">⌵</span>
            </div>
            <div class="string-array-editor-content" id="content-${uniqueId}">
                <textarea class="string-array-textarea" id="textarea-${uniqueId}" placeholder="Enter one item per line..."></textarea>
                <p class="string-array-help-text">Each line will be treated as a separate string in the array.</p>
                <div class="string-array-buttons">
                    <button type="button" class="string-array-btn sae-cancel-btn" data-textarea-id="textarea-${uniqueId}" data-category="${category}" data-key="${key}" data-count-id="count-${uniqueId}" data-content-id="content-${uniqueId}" data-arrow-id="arrow-${uniqueId}">Cancel</button>
                    <button type="button" class="string-array-btn primary sae-apply-btn" data-textarea-id="textarea-${uniqueId}" data-category="${category}" data-key="${key}" data-count-id="count-${uniqueId}" data-content-id="content-${uniqueId}" data-arrow-id="arrow-${uniqueId}">Apply</button>
                </div>
            </div>
        `;
    } else if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object' && value[0] !== null) {
        setting.className = 'setting-group';
        setting.innerHTML = `<h3>${formattedLabel}</h3>`;
        value.forEach((object, index) => {
            const objectContainer = document.createElement('div');
            objectContainer.className = 'object-item setting';
            objectContainer.innerHTML = `<div class="setting-label" style="margin-bottom: 10px; font-weight: bold;">Item ${index + 1}</div>`;
            Object.entries(object).forEach(([objKey, objValue]) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'object-field';
                const objDataPath = `${dataPath}[${index}].${objKey}`;
                fieldDiv.innerHTML = `
                    <label for="${key}-${index}-${objKey}">${formatLabel(objKey)}:</label>
                    <input type="text"
                        id="${key}-${index}-${objKey}"
                        value="${objValue || ''}"
                        data-path="${objDataPath}"
                        data-key="${objKey}">
                `;
                objectContainer.appendChild(fieldDiv);
            });
            setting.appendChild(objectContainer);
        });
    } else if (typeof value === 'object' && value !== null && !Array.isArray(value) && Object.keys(value).some(k => !isNaN(parseInt(k)))) {
        setting.className = 'setting-group';
        setting.innerHTML = `<h3>${formattedLabel}</h3>`;
        Object.entries(value).forEach(([objKey, objValue]) => {
            if (typeof objValue === 'boolean') {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'setting';
                fieldDiv.style.marginLeft = '0';
                const objDataPath = `${dataPath}.${objKey}`;
                fieldDiv.innerHTML = `
                    <label class="setting-checkbox">
                        <input type="checkbox" data-path="${objDataPath}" data-key="${objKey}" ${objValue ? 'checked' : ''}>
                        <span class="checkmark"></span>
                        <span class="toggle-label">SDK Version ${objKey}</span>
                        <span class="toggle-status">${objValue ? 'Enabled' : 'Disabled'}</span>
                    </label>
                `;
                setting.appendChild(fieldDiv);
            }
        });
    } else if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        setting.className = 'setting-group';
        setting.innerHTML = `<h3>${formattedLabel}</h3>`;
        Object.entries(value).forEach(([objKey, objValue]) => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'setting';
            fieldDiv.style.marginLeft = '0';
            const objDataPath = `${dataPath}.${objKey}`;
            let inputElement;
            const objLabel = formatLabel(objKey);

            if (typeof objValue === 'boolean') {
                inputElement = `
                    <label class="setting-checkbox">
                        <input type="checkbox" data-path="${objDataPath}" data-key="${objKey}" ${objValue ? 'checked' : ''}>
                        <span class="checkmark"></span>
                        <span class="toggle-label">${objLabel}</span>
                        <span class="toggle-status">${objValue ? 'Enabled' : 'Disabled'}</span>
                    </label>
                `;
                 fieldDiv.innerHTML = inputElement;
            } else {
                if (typeof objValue === 'number') {
                    inputElement = `<input type="number" data-path="${objDataPath}" data-key="${objKey}" value="${objValue}">`;
                } else {
                    inputElement = `<input type="text" data-path="${objDataPath}" data-key="${objKey}" value="${objValue || ''}">`;
                }
                 fieldDiv.innerHTML = `
                    <label class="setting-label">${objLabel}</label>
                    ${inputElement}
                `;
            }
            setting.appendChild(fieldDiv);
        });
    } else if (Array.isArray(value)) {
        setting.className = 'array-field setting';
        const isIdentitySetting = key.startsWith('change') &&
            (key.includes('Id') || key.includes('Mac') || key.includes('Imei') ||
             key.includes('Imsi') || key.includes('Serial') || key.includes('Locale') ||
             key.includes('Advertising') || key.includes('Address') || key.includes('Framework'));

        const customInputId = `${category}-${key}-custom-input-${Date.now()}`;
        setting.innerHTML = `
            <label class="setting-label">
                ${formattedLabel}
                <span style="font-size: 12px; color: #666; margin-left: 8px;">
                    (${value.length} options)
                </span>
            </label>
            <select data-path="${dataPath}" data-key="${key}">
                ${value.map(option => `<option value="${option}">${option}</option>`).join('')}
                ${isIdentitySetting ? '<option value="custom">CUSTOM</option>' : ''}
            </select>
            ${isIdentitySetting ?
              `<div class="custom-input-container" style="display:none;">
                  <input type="text" id="${customInputId}" class="setting custom-input" data-path="${dataPath}" data-key="${key}-custom" placeholder="Enter custom value">
                  <button type="button" class="generate-btn" data-target-input="${customInputId}" data-setting-key="${key}">Generate</button>
               </div>` :
              ''}
        `;
    } else if (typeof value === 'boolean') { // Standard boolean toggle
        setting.className = 'setting';
        setting.innerHTML = `
            <label class="setting-checkbox">
                <input type="checkbox" data-path="${dataPath}" data-key="${key}" ${value ? 'checked' : ''}>
                <span class="checkmark"></span>
                <span class="toggle-label">${formattedLabel}</span>
                <span class="toggle-status">${value ? 'Enabled' : 'Disabled'}</span>
            </label>
        `;
        const childSettingsContainer = document.createElement('div');
        childSettingsContainer.className = 'child-settings-container';
        childSettingsContainer.dataset.parentKey = key;

        // Generic child settings (those starting with parentKey and having specific suffix)
        for (const childKey in allSettingsInCategory) {
            if (childKey.startsWith(key) && childKey !== key &&
                childKey !== 'fakeCalculatorCode' && childKey !== 'appPatternSize' && childKey !== 'appPattern') { // Exclude explicitly handled children
                 const suffix = childKey.substring(key.length);
                 if (suffix && (suffix[0] === suffix[0].toUpperCase() || !isNaN(parseInt(suffix[0])) || suffix === 'Value' )) {
                    const childValue = allSettingsInCategory[childKey];
                    if (typeof allSettingsInCategory[key] === 'boolean') { // Ensure parent is boolean
                        const childSettingElement = createSettingElement(childKey, childValue, category, allSettingsInCategory);
                        if (childSettingElement) {
                            childSettingElement.classList.add('child-setting');
                            childSettingsContainer.appendChild(childSettingElement);
                        }
                    }
                 }
            }
        }

        if (key === 'fakeCalculator') {
            const codeKey = 'fakeCalculatorCode';
            const codeValue = allSettingsInCategory[codeKey];
            const codeSettingElement = document.createElement('div');
            codeSettingElement.className = 'setting child-setting';
            const codeLabel = formatLabel(codeKey);
            const dataPathForCode = `${category}.${codeKey}`;
            codeSettingElement.innerHTML = `
                <label class="setting-label">${codeLabel}</label>
                <input type="text" data-path="${dataPathForCode}" data-key="${codeKey}" value="${codeValue !== undefined ? codeValue : ''}" placeholder="Enter unlock code">
            `;
            childSettingsContainer.appendChild(codeSettingElement);
        }

        if (key === 'patternLockApp') {
            const sizeKey = 'appPatternSize';
            const currentSizeValue = allSettingsInCategory[sizeKey] !== undefined ? allSettingsInCategory[sizeKey] : 4;
            const patternKey = 'appPattern';
            const currentPatternValue = allSettingsInCategory[patternKey] !== undefined ? allSettingsInCategory[patternKey] : "";

            const sizeSettingElement = document.createElement('div');
            sizeSettingElement.className = 'setting child-setting';
            const sizeLabel = formatLabel(sizeKey);
            const dataPathForSize = `${category}.${sizeKey}`;
            sizeSettingElement.innerHTML = `
                <label class="setting-label">${sizeLabel}</label>
                <input type="number" data-path="${dataPathForSize}" data-key="${sizeKey}" value="${currentSizeValue}" min="3" max="9">`;
            childSettingsContainer.appendChild(sizeSettingElement);

            const patternSettingElement = document.createElement('div');
            patternSettingElement.className = 'setting child-setting';
            const patternLabel = formatLabel(patternKey);
            const dataPathForPattern = `${category}.${patternKey}`;
            patternSettingElement.innerHTML = `
                <label class="setting-label">${patternLabel}</label>
                <input type="text" data-path="${dataPathForPattern}" data-key="${patternKey}" value="${currentPatternValue}" placeholder="e.g., 0,1,2,3,7,6">`;
            childSettingsContainer.appendChild(patternSettingElement);
        }


        if (childSettingsContainer.hasChildNodes()) {
            setting.appendChild(childSettingsContainer);
        }
    } else if (typeof value === 'number' && (key.includes('Battery') || key.includes('battery') || key.includes('Level'))) {
        setting.className = 'setting';
        let min = 0, max = 100, step = 1, unit = '%';
        if (key.includes('Temp')) { min = -20; max = 80; unit = '°C'; }
        else if (key.includes('Voltage')) { min = 3000; max = 4500; unit = 'mV'; step = 10; }
        setting.innerHTML = `
            <label class="setting-label">${formattedLabel}</label>
            <div class="slider-container">
                <input type="range" data-path="${dataPath}" data-key="${key}" value="${value}" min="${min}" max="${max}" step="${step}">
                <span class="slider-value">${value}${unit}</span>
            </div>
        `;
    } else if (typeof value === 'number') {
        setting.className = 'setting';
        setting.innerHTML = `
            <label class="setting-label">${formattedLabel}</label>
            <input type="number" data-path="${dataPath}" data-key="${key}" value="${value}">
        `;
    } else if (key === 'customCode' || key === 'fridaScript') { // ADDED FOR CUSTOM CODE AND FRIDA SCRIPT
        setting.className = 'setting';
        let placeholderText = `Enter code here...`;
        if (key === 'customCode') {
            placeholderText = `Enter Java code here...`;
        } else if (key === 'fridaScript') {
            placeholderText = `Enter Frida (JavaScript) code here...`;
        }
        setting.innerHTML = `
            <label class="setting-label">${formattedLabel}</label>
            <textarea class="code-input" data-path="${dataPath}" data-key="${key}" rows="8" placeholder="${placeholderText}">${value || ''}</textarea>
        `;
    } else {
        if (key === 'appPassword') {
            setting.className = 'setting';
            const isEnabled = typeof value === 'string' && value !== "";
            const toggleId = `${category}-${key}-enable-toggle-${Date.now()}`;
            const passwordInputId = `input-${toggleId}`;

            setting.innerHTML = `
                <label class="setting-checkbox">
                    <input type="checkbox" id="${toggleId}" data-controls-input-id="${passwordInputId}" ${isEnabled ? 'checked' : ''}>
                    <span class="checkmark"></span>
                    <span class="toggle-label">${formattedLabel} (Enable/Disable)</span>
                    <span class="toggle-status">${isEnabled ? 'Enabled' : 'Disabled'}</span>
                </label>
                <div class="child-settings-container ${isEnabled ? 'active' : ''}" data-controlled-by-toggle-id="${toggleId}">
                    <div class="child-setting">
                        <label class="setting-label">Password Code</label>
                        <input type="text" id="${passwordInputId}" data-path="${dataPath}" data-key="${key}" value="${value || ''}" placeholder="Enter password">
                    </div>
                </div>
            `;
        } else {
            setting.className = 'setting';
            setting.innerHTML = `
                <label class="setting-label">${formattedLabel}</label>
                <input type="text" data-path="${dataPath}" data-key="${key}" value="${value || ''}">
            `;
        }
    }
    return setting;
}

function generateRandomValue(settingKey) {
    const keyLower = settingKey.toLowerCase();
    const hex = () => Math.floor(Math.random() * 16).toString(16);
    const generateUUID = () => `${Array.from({length: 8}, hex).join('')}-${Array.from({length: 4}, hex).join('')}-4${Array.from({length: 3}, hex).join('')}-${['8','9','a','b'][Math.floor(Math.random()*4)]}${Array.from({length: 3}, hex).join('')}-${Array.from({length: 12}, hex).join('')}`;
    const generateAlphaNumUpper = (length) => { let r = ''; const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; for (let i = 0; i < length; i++) r += c.charAt(Math.floor(Math.random() * c.length)); return r; };

    if (keyLower.includes('wifimacaddress') || keyLower.includes('bluetoothmacaddress')) return Array.from({ length: 6 }, () => Math.floor(Math.random() * 256).toString(16).padStart(2, '0')).join(':').toUpperCase();
    if (keyLower.includes('imei')) return Array.from({ length: 15 }, () => Math.floor(Math.random() * 10)).join('');
    if (keyLower.includes('androidid')) return Array.from({ length: 16 }, hex).join('');
    if (keyLower.includes('simserialnumber')) return Array.from({ length: Math.floor(Math.random() * 3) + 18 }, () => Math.floor(Math.random() * 10)).join('');
    if (keyLower.includes('advertisingid')) return generateUUID();
    if (keyLower.includes('imsi')) { const mcc = ['310', '311', '208', '234'][Math.floor(Math.random()*4)]; const mnc = ['150', '260', '410', '010', '020', '015', '020'][Math.floor(Math.random()*7)]; const msin = Array.from({ length: 10 }, () => Math.floor(Math.random()*10)).join(''); return mcc + mnc.padStart(3, '0') + msin; }
    if (keyLower.includes('openid')) return generateUUID();
    if (keyLower.includes('googleserviceframeworkid') || keyLower.includes('gsfid')) return Array.from({ length: 16 }, hex).join('');
    if (keyLower.includes('facebookattributionid')) return generateUUID();
    if (keyLower.includes('appsetid')) return generateUUID();
    if (keyLower.includes('hardwareserial') || settingKey === 'changeAndroidSerial') return generateAlphaNumUpper(Math.floor(Math.random() * 7) + 10);

    console.warn(`No specific random generator implemented for key: ${settingKey}. Returning placeholder.`);
    return `RANDOM_${settingKey.replace(/([A-Z])/g, '_$1').toUpperCase()}`;
}

function formatLabel(key) {
    if (!key) return '';
    let result = key.replace(/([A-Z])/g, ' $1');
    result = result.charAt(0).toUpperCase() + result.slice(1);
    result = result.replace(/Sdk( |$)/g, 'SDK ').replace(/Id( |$)/g, 'ID ').replace(/Mac( |$)/g, 'MAC ').replace(/Imei( |$)/g, 'IMEI ').replace(/Imsi( |$)/g, 'IMSI ');
    return result.trim();
}

function initializeEventListeners() {
    const container = document.getElementById('config-container');
    if (!container) return;

    container.addEventListener('click', function(event) {
        const categoryHeader = event.target.closest('.category-header');
        if (categoryHeader) {
            const content = categoryHeader.nextElementSibling;
            const chevron = categoryHeader.querySelector('.chevron');
            if (content && chevron) {
                content.classList.toggle('active');
                chevron.classList.toggle('active');
            }
            return;
        }

        const saeHeader = event.target.closest('.string-array-editor-header');
        if (saeHeader) {
            const contentId = saeHeader.dataset.targetContent;
            const arrowId = saeHeader.dataset.targetArrow;
            const contentElement = document.getElementById(contentId);
            const arrowElement = document.getElementById(arrowId);
            if (contentElement && arrowElement) {
                contentElement.classList.toggle('active');
                arrowElement.classList.toggle('expanded');
            }
            return;
        }

        if (event.target.classList.contains('sae-apply-btn')) {
            const btn = event.target;
            const textareaId = btn.dataset.textareaId;
            const category = btn.dataset.category;
            const key = btn.dataset.key;
            const countId = btn.dataset.countId;
            const contentId = btn.dataset.contentId;
            const arrowId = btn.dataset.arrowId;

            const textarea = document.getElementById(textareaId);
            const countElement = document.getElementById(countId);
            const contentElement = document.getElementById(contentId);
            const arrowElement = document.getElementById(arrowId);

            if (textarea && jsonConfig[category] && Object.hasOwnProperty.call(jsonConfig[category], key)) {
                const lines = textarea.value.split('\n').map(line => line.trim()).filter(line => line !== '');
                jsonConfig[category][key] = lines;
                if (countElement) countElement.textContent = `Options: ${lines.length}`;
                if (contentElement) contentElement.classList.remove('active');
                if (arrowElement) arrowElement.classList.remove('expanded');
            }
            return;
        }

        if (event.target.classList.contains('sae-cancel-btn')) {
            const btn = event.target;
            const textareaId = btn.dataset.textareaId;
            const category = btn.dataset.category;
            const key = btn.dataset.key;
            const countId = btn.dataset.countId;
            const contentId = btn.dataset.contentId;
            const arrowId = btn.dataset.arrowId;

            const textarea = document.getElementById(textareaId);
            const countElement = document.getElementById(countId);
            const contentElement = document.getElementById(contentId);
            const arrowElement = document.getElementById(arrowId);

            if (textarea) textarea.value = '';
            if (jsonConfig[category] && Object.hasOwnProperty.call(jsonConfig[category], key)) {
                if (countElement) countElement.textContent = `Options: ${jsonConfig[category][key].length}`;
            }
            if (contentElement) contentElement.classList.remove('active');
            if (arrowElement) arrowElement.classList.remove('expanded');
            return;
        }


        if (event.target.classList.contains('generate-btn')) {
            event.preventDefault();
            const button = event.target;
            const targetInputId = button.dataset.targetInput;
            const settingKey = button.dataset.settingKey;
            const targetInput = document.getElementById(targetInputId);
            if (targetInput && settingKey) {
                targetInput.value = generateRandomValue(settingKey) || '';
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                targetInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            return;
        }
    });

    container.addEventListener('change', function(event) {
        if (event.target.type === 'checkbox') {
            const checkbox = event.target;
            const statusElement = checkbox.closest('.setting-checkbox').querySelector('.toggle-status');
            if (statusElement) statusElement.textContent = checkbox.checked ? 'Enabled' : 'Disabled';

            const controlledInputId = checkbox.dataset.controlsInputId;
            const childContainerControlledByToggle = document.querySelector(`.child-settings-container[data-controlled-by-toggle-id="${checkbox.id}"]`);

            if (childContainerControlledByToggle && controlledInputId) { // For appPassword structure
                childContainerControlledByToggle.classList.toggle('active', checkbox.checked);
                const passwordInput = document.getElementById(controlledInputId);
                if (passwordInput) {
                    if (!checkbox.checked) {
                        passwordInput.value = "";
                        passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                        passwordInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            } else { // Generic logic for parentKey-based child containers (e.g., fakeCalculator, patternLockApp)
                const parentKey = checkbox.dataset.key;
                const settingDiv = checkbox.closest('.setting');
                if (settingDiv && parentKey) {
                    const childSettingsContainer = settingDiv.querySelector(`.child-settings-container[data-parent-key="${parentKey}"]`);
                    if (childSettingsContainer) {
                        childSettingsContainer.classList.toggle('active', checkbox.checked);
                    }
                }
            }
        }
        if (event.target.tagName === 'SELECT') {
            const select = event.target;
            const customContainer = select.parentElement.querySelector('.custom-input-container');
            if (customContainer) {
                const customInput = customContainer.querySelector('.custom-input');
                if (select.value === 'custom') customContainer.style.display = 'flex';
                else {
                    customContainer.style.display = 'none';
                    if (customInput) customInput.value = '';
                }
            }
        }
    });

     container.addEventListener('input', function(event) {
         if (event.target.type === 'range') {
            const slider = event.target;
            const sliderContainer = slider.closest('.slider-container');
            if (sliderContainer) {
                 const valueDisplay = sliderContainer.querySelector('.slider-value');
                 if (valueDisplay) {
                     let unit = '';
                     if (slider.closest('.setting')) {
                         const label = slider.closest('.setting').querySelector('.setting-label')?.textContent || '';
                         if (label.includes('Temp')) unit = '°C';
                         else if (label.includes('Voltage')) unit = 'mV';
                         else if (label.includes('Level') || label.includes('Battery')) unit = '%';
                     }
                     valueDisplay.textContent = slider.value + unit;
                 }
            }
            return;
         }
     });

    container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.dispatchEvent(new Event('change', { bubbles: true })));
    container.querySelectorAll('.array-field select').forEach(select => select.dispatchEvent(new Event('change', { bubbles: true })));
    container.querySelectorAll('input[type="range"]').forEach(slider => slider.dispatchEvent(new Event('input', { bubbles: true })));
}


function getUpdatedConfig() {
    const updatedConfigStructured = JSON.parse(JSON.stringify(jsonConfig));
    const processedCustomFields = new Set();

    for (const category in updatedConfigStructured) {
        if (Object.hasOwnProperty.call(updatedConfigStructured, category)) {
            const settings = updatedConfigStructured[category];
            for (const key in settings) {
                if (Object.hasOwnProperty.call(settings, key)) {
                    const dataPath = `${category}.${key}`;

                    if (NON_INTERACTIVE_DIRECTORY_KEYS.includes(key) || key === 'fakeWifiNetworks') {
                        continue;
                    }

                    if (key === 'fakeCalculator' && typeof settings[key] === 'boolean') {
                        const parentCheckbox = document.querySelector(`input[type="checkbox"][data-path="${dataPath}"][data-key="${key}"]`);
                        if (parentCheckbox) {
                            updatedConfigStructured[category][key] = parentCheckbox.checked;

                            const codeKey = 'fakeCalculatorCode';
                            const codeDataPath = `${category}.${codeKey}`;
                            const codeElement = document.querySelector(`input[type="text"][data-path="${codeDataPath}"][data-key="${codeKey}"]`);
                            if (codeElement) {
                                updatedConfigStructured[category][codeKey] = codeElement.value;
                            } else if (parentCheckbox.checked && !updatedConfigStructured[category].hasOwnProperty(codeKey)) {
                                updatedConfigStructured[category][codeKey] = ""; // Default if parent active and key missing
                            }
                        }
                        continue;
                    } else if (key === 'patternLockApp' && typeof settings[key] === 'boolean') {
                        const parentCheckbox = document.querySelector(`input[type="checkbox"][data-path="${dataPath}"][data-key="${key}"]`);
                        if (parentCheckbox) {
                            updatedConfigStructured[category][key] = parentCheckbox.checked;

                            const sizeKey = 'appPatternSize';
                            const sizeDataPath = `${category}.${sizeKey}`;
                            const sizeElement = document.querySelector(`input[type="number"][data-path="${sizeDataPath}"][data-key="${sizeKey}"]`);
                            if (sizeElement) {
                                let sizeVal = parseInt(sizeElement.value, 10);
                                updatedConfigStructured[category][sizeKey] = isNaN(sizeVal) ? 4 : sizeVal;
                            } else if (parentCheckbox.checked) {
                                updatedConfigStructured[category][sizeKey] = 4; // Default if active and element missing
                            }

                            const patternKey = 'appPattern';
                            const patternDataPath = `${category}.${patternKey}`;
                            const patternElement = document.querySelector(`input[type="text"][data-path="${patternDataPath}"][data-key="${patternKey}"]`);
                            if (patternElement) {
                                updatedConfigStructured[category][patternKey] = patternElement.value;
                            } else if (parentCheckbox.checked) {
                                updatedConfigStructured[category][patternKey] = ""; // Default if active and element missing
                            }
                        }
                        continue;
                    }


                    if (typeof settings[key] === 'object' && settings[key] !== null && !Array.isArray(settings[key])) {
                        const currentObject = settings[key];
                        const newObject = {};
                        Object.keys(currentObject).forEach(objKey => {
                            const objElementPath = `${dataPath}.${objKey}`;
                            const objElement = document.querySelector(`[data-path="${objElementPath}"]`);
                            if (objElement) {
                                let value;
                                if (objElement.type === 'checkbox') value = objElement.checked;
                                else if (objElement.type === 'number' || objElement.type === 'range') value = parseFloat(objElement.value) || 0;
                                else value = objElement.value; // Covers text, textarea, select, etc.
                                newObject[objKey] = value;
                            } else {
                                newObject[objKey] = currentObject[objKey];
                            }
                        });
                        updatedConfigStructured[category][key] = newObject;
                        continue;
                    }

                    if (Array.isArray(settings[key]) && settings[key].length === 0 && document.querySelector(`[data-category="${category}"][data-key="${key}"].sae-apply-btn`)) {
                        // String array editor values are updated directly into jsonConfig by their apply buttons.
                        // So, updatedConfigStructured will already have the latest from jsonConfig.
                        continue;
                    }

                    const element = document.querySelector(`[data-path="${dataPath}"][data-key="${key}"]`);

                    if (!element) {
                        const checkboxElement = document.querySelector(`input[type="checkbox"][data-path="${dataPath}"][data-key="${key}"]`);
                        if (checkboxElement) {
                            updatedConfigStructured[category][key] = checkboxElement.checked;
                        }
                        continue;
                    }

                    let value;
                    if (element.type === 'checkbox') {
                        value = element.checked;
                    } else if (element.type === 'number' || element.type === 'range') {
                        value = parseFloat(element.value) || 0;
                    } else if (element.tagName === 'SELECT') {
                        if (element.value === 'custom') {
                            const customInput = document.querySelector(`input[data-path="${dataPath}"][data-key="${key}-custom"]`);
                            if (customInput) {
                                updatedConfigStructured[category][key] = "CUSTOM";
                                let customPropertyName;
                                if (key.startsWith('change')) {
                                    let baseProperty = key.substring(6);
                                    if (baseProperty.endsWith('ID')) baseProperty = baseProperty.substring(0, baseProperty.length - 2) + 'Id';
                                    else if (baseProperty.endsWith('Mac')) baseProperty = baseProperty.substring(0, baseProperty.length - 3) + 'MAC';
                                    baseProperty = baseProperty.charAt(0).toLowerCase() + baseProperty.slice(1);
                                    customPropertyName = 'custom' + baseProperty.charAt(0).toUpperCase() + baseProperty.slice(1);
                                } else {
                                    customPropertyName = 'custom' + key.charAt(0).toUpperCase() + key.slice(1);
                                }
                                updatedConfigStructured[category][customPropertyName] = customInput.value;
                                processedCustomFields.add(key);
                                continue;
                            } else {
                                value = "CUSTOM";
                            }
                        } else {
                            value = element.value;
                            let customPropertyName;
                            if (key.startsWith('change')) {
                                let baseProperty = key.substring(6);
                                if (baseProperty.endsWith('ID')) baseProperty = baseProperty.substring(0, baseProperty.length - 2) + 'Id';
                                else if (baseProperty.endsWith('Mac')) baseProperty = baseProperty.substring(0, baseProperty.length - 3) + 'MAC';
                                baseProperty = baseProperty.charAt(0).toLowerCase() + baseProperty.slice(1);
                                customPropertyName = 'custom' + baseProperty.charAt(0).toUpperCase() + baseProperty.slice(1);
                            } else {
                                customPropertyName = 'custom' + key.charAt(0).toUpperCase() + key.slice(1);
                            }
                            if (updatedConfigStructured[category] && Object.hasOwnProperty.call(updatedConfigStructured[category], customPropertyName)) {
                                delete updatedConfigStructured[category][customPropertyName];
                            }
                        }
                    } else { // Covers text input, textarea
                        value = element.value;
                    }

                    if (!processedCustomFields.has(key)) {
                        updatedConfigStructured[category][key] = value;
                    }
                }
            }
        }
    }

    const flatConfig = {};
    for (const category in updatedConfigStructured) {
        if (Object.hasOwnProperty.call(updatedConfigStructured, category)) {
            const settingsInCategory = updatedConfigStructured[category];
            for (const keyInCat in settingsInCategory) {
                if (Object.hasOwnProperty.call(settingsInCategory, keyInCat)) {
                    flatConfig[keyInCat] = settingsInCategory[keyInCat];
                }
            }
        }
    }

    if (Object.hasOwnProperty.call(flatConfig, 'appPassword') && flatConfig.appPassword === "") {
        delete flatConfig.appPassword;
    }

    if (Object.hasOwnProperty.call(flatConfig, 'fakeCalculator') && flatConfig.fakeCalculator === false) {
        if (Object.hasOwnProperty.call(flatConfig, 'fakeCalculatorCode')) {
            delete flatConfig.fakeCalculatorCode;
        }
    }

    if (Object.hasOwnProperty.call(flatConfig, 'patternLockApp') && flatConfig.patternLockApp === false) {
        if (Object.hasOwnProperty.call(flatConfig, 'appPatternSize')) {
            delete flatConfig.appPatternSize;
        }
        if (Object.hasOwnProperty.call(flatConfig, 'appPattern')) {
            delete flatConfig.appPattern;
        }
    }

    return flatConfig;
}


function saveConfig() {
    let packageName = currentPackageName;
    if (!packageName) {
        packageName = prompt("Package name not detected. Please enter the package name to encrypt the configuration:");
        if (!packageName || packageName.trim() === '') {
            alert("Package name is required to encrypt and save the configuration.");
            if(window.Android) window.Android.showToast("Save cancelled: Package name required.");
            return;
        }
        updatePackageName(packageName);
    }

    const finalFlatConfig = getUpdatedConfig();
    const jsonString = JSON.stringify(finalFlatConfig, null, 2);

    if (window.Android) {
        try {
            window.Android.saveEncryptedConfig(jsonString, packageName, configFileSplitCount);
            window.Android.showToast("Configuration saved successfully!");
        } catch (e) {
            console.error("Error calling Android.saveEncryptedConfig:", e);
            const errorMessage = `Error saving config: ${e.message}`;
            window.Android.showToast(errorMessage);
            alert(`Error saving config via Android interface: ${e.message}\n\nPlease check Android Studio Logcat for details.`);
        }
    } else {
        console.warn("Running in browser mode. Configuration will be downloaded as plain text JSON.");
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${packageName}_cloneSettings.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Running in browser mode. Configuration downloaded as JSON file (not encrypted).");
    }
}

</script>
</body>
</html>
